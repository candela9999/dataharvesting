<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>5 Case study: scraping Spanish school locations from the web | Data Harvesting with R</title>
<meta name="author" content="Jorge Cimentada">
<meta name="description" content="In this case study we’ll working through the basics of web scraping using R and the xml2 package. We’ll begin with a simple example using fake data and elaborate further by trying to scrape the...">
<meta name="generator" content="bookdown 0.26 with bs4_book()">
<meta property="og:title" content="5 Case study: scraping Spanish school locations from the web | Data Harvesting with R">
<meta property="og:type" content="book">
<meta property="og:url" content="https://cimentadaj.github.io/dataharvesting/case-study-scraping-spanish-school-locations-from-the-web.html">
<meta property="og:description" content="In this case study we’ll working through the basics of web scraping using R and the xml2 package. We’ll begin with a simple example using fake data and elaborate further by trying to scrape the...">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="5 Case study: scraping Spanish school locations from the web | Data Harvesting with R">
<meta name="twitter:description" content="In this case study we’ll working through the basics of web scraping using R and the xml2 package. We’ll begin with a simple example using fake data and elaborate further by trying to scrape the...">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script><link href="libs/_Lato-0.4.1/font.css" rel="stylesheet">
<link href="libs/_Roboto%20Mono-0.4.1/font.css" rel="stylesheet">
<link href="libs/_Montserrat-0.4.1/font.css" rel="stylesheet">
<script src="libs/bs3compat-0.3.1/transition.js"></script><script src="libs/bs3compat-0.3.1/tabs.js"></script><script src="libs/bs3compat-0.3.1/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><script src="libs/accessible-code-block-0.0.1/empty-anchor.js"></script><link rel="icon" type="image/png" sizes="32x32" href="images/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="images/favicon-16x16.png">
<script>
   (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
       (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
   })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  
   ga('create', 'UA-99618359-1', 'auto');
   ga('send', 'pageview');
  
  </script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- CSS --><link rel="stylesheet" href="style/style.css">
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h2>
        <a href="index.html" title="">Data Harvesting with R</a>
      </h2>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html"><span class="header-section-number">1</span> Introduction</a></li>
<li><a class="" href="introduction-to-webscraping.html"><span class="header-section-number">2</span> Introduction to Webscraping</a></li>
<li><a class="" href="a-primer-on-webscraping.html"><span class="header-section-number">3</span> A primer on Webscraping</a></li>
<li><a class="" href="data-formats-for-webscraping.html"><span class="header-section-number">4</span> Data Formats for Webscraping</a></li>
<li><a class="active" href="case-study-scraping-spanish-school-locations-from-the-web.html"><span class="header-section-number">5</span> Case study: scraping Spanish school locations from the web</a></li>
<li><a class="" href="footnotes-and-citations.html"><span class="header-section-number">6</span> Footnotes and citations</a></li>
<li><a class="" href="sharing-your-book.html"><span class="header-section-number">7</span> Sharing your book</a></li>
<li><a class="" href="references.html">References</a></li>
<li><a class="" href="cross.html"><span class="header-section-number">8</span> Cross-references</a></li>
<li><a class="" href="parts.html"><span class="header-section-number">9</span> Parts</a></li>
</ul>

        <div class="book-extra">
          <p><a id="book-repo" href="https://github.com/cimentadaj/dataharvesting/tree/main/book">View book source <i class="fab fa-github"></i></a></p>
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="case-study-scraping-spanish-school-locations-from-the-web" class="section level1">
<h1>
<span class="header-section-number">5</span> Case study: scraping Spanish school locations from the web<a class="anchor" aria-label="anchor" href="#case-study-scraping-spanish-school-locations-from-the-web"><i class="fas fa-link"></i></a>
</h1>
<p>In this case study we’ll working through the basics of web scraping using R and the <code>xml2</code> package. We’ll begin with a simple example using fake data and elaborate further by trying to scrape the location of a sample of schools in Spain.</p>
<div id="basic-steps" class="section level2">
<h2>
<span class="header-section-number">5.1</span> Basic steps<a class="anchor" aria-label="anchor" href="#basic-steps"><i class="fas fa-link"></i></a>
</h2>
<p>For web scraping in <code>R</code>, you can fulfill almost all of your needs with the <code>xml2</code> package. As you wander through the web, you’ll see many examples using the <code>rvest</code> package. <code>xml2</code> and <code>rvest</code> are very similar so don’t feel you’re lacking behind for learning one and not the other. In addition to these two packages, we’ll need some other libraries for plotting locations on a map (<code>ggplot2</code>, <code>sf</code>, <code>rnaturalearth</code>), identifying who we are when we scrape (<code>httr</code>) and wrangling data (<code>tidyverse</code>).</p>
<p>Additionally, we’ll also need the package <code>scrapex</code>. In the real-world example that we’ll be doing below, we’ll be scraping data from the website <code>www.buscocolegio.com</code> to locate a sample of schools in Spain. However, throughout the tutorial we won’t be scraping the data directly from their real-website. What would happen to this tutorial if 6 months from now <code>www.buscocolegio.com</code> updates the design of their website? Everything from our real-world example would be lost.</p>
<p>Web scraping tutorials are usually very unstable precisely because of this. To circumvent that problem, I’ve saved a random sample of websites from some schools in <code>www.buscocolegio.com</code> into an R package called <code>scrapex</code>. Although the links we’ll be working on will be hosted locally on your machine, the HTML of the website should be very similar to the one hosted on the website (with the exception of some images/icons which were deleted on purpose to make the package lightweight).</p>
<p>You can install the package with:</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># install.packages("devtools")</span>
<span class="fu">devtools</span><span class="fu">::</span><span class="fu"><a href="https://devtools.r-lib.org/reference/remote-reexports.html">install_github</a></span><span class="op">(</span><span class="st">"cimentadaj/scrapex"</span><span class="op">)</span></code></pre></div>
<p>Now, let’s move on the fake data example and load all of our packages with:</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://xml2.r-lib.org/">xml2</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://httr.r-lib.org/">httr</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/">sf</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/ropenscilabs/rnaturalearth">rnaturalearth</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org">ggplot2</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">scrapex</span><span class="op">)</span></code></pre></div>
<p>Let’s begin with a simple example. Below we define an XML string and look at its structure:</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">xml_test</span> <span class="op">&lt;-</span> <span class="st">"&lt;people&gt;
&lt;jason&gt;
  &lt;person type='fictional'&gt;
    &lt;first_name&gt;
      &lt;married&gt;
        Jason
      &lt;/married&gt;
    &lt;/first_name&gt;
    &lt;last_name&gt;
        Bourne
    &lt;/last_name&gt;
    &lt;occupation&gt;
      Spy
    &lt;/occupation&gt;
  &lt;/person&gt;
&lt;/jason&gt;
&lt;carol&gt;
  &lt;person type='real'&gt;
    &lt;first_name&gt;
      &lt;married&gt;
        Carol
      &lt;/married&gt;
    &lt;/first_name&gt;
    &lt;last_name&gt;
        Kalp
    &lt;/last_name&gt;
    &lt;occupation&gt;
      Scientist
    &lt;/occupation&gt;
  &lt;/person&gt;
&lt;/carol&gt;
&lt;/people&gt;
"</span>

<span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="va">xml_test</span><span class="op">)</span></code></pre></div>
<pre><code>## &lt;people&gt;
## &lt;jason&gt;
##   &lt;person type='fictional'&gt;
##     &lt;first_name&gt;
##       &lt;married&gt;
##         Jason
##       &lt;/married&gt;
##     &lt;/first_name&gt;
##     &lt;last_name&gt;
##         Bourne
##     &lt;/last_name&gt;
##     &lt;occupation&gt;
##       Spy
##     &lt;/occupation&gt;
##   &lt;/person&gt;
## &lt;/jason&gt;
## &lt;carol&gt;
##   &lt;person type='real'&gt;
##     &lt;first_name&gt;
##       &lt;married&gt;
##         Carol
##       &lt;/married&gt;
##     &lt;/first_name&gt;
##     &lt;last_name&gt;
##         Kalp
##     &lt;/last_name&gt;
##     &lt;occupation&gt;
##       Scientist
##     &lt;/occupation&gt;
##   &lt;/person&gt;
## &lt;/carol&gt;
## &lt;/people&gt;</code></pre>
<p>In XML and HTML the basic building blocks are something called tags. For example, the first tag in the structure shown above is <code>&lt;people&gt;</code>. This tag is matched by <code>&lt;/people&gt;</code> at the end of the string:</p>
<div class="inline-figure"><img src="images/cs_spanish_school_locations/xml_examples/xml_one.png" width="30%" style="display: block; margin: auto;"></div>
<p>If you pay close attention, you’ll see that <strong>each</strong> tag in the XML structure has a beginning (signaled by <code>&lt;&gt;</code>) and an end (signaled by <code>&lt;/&gt;</code>). For example, the next tag after <code>&lt;people&gt;</code> is <code>&lt;jason&gt;</code> and right before the tag <code>&lt;carol&gt;</code> is the end of the jason tag <code>&lt;/jason&gt;</code>.</p>
<div class="inline-figure"><img src="images/cs_spanish_school_locations/xml_examples/xml_two.png" width="30%" style="display: block; margin: auto;"></div>
<p>Similarly, you’ll find that the <code>&lt;carol&gt;</code> tag is also matched by a <code>&lt;/carol&gt;</code> finishing tag.</p>
<div class="inline-figure"><img src="images/cs_spanish_school_locations/xml_examples/xml_three.png" width="30%" style="display: block; margin: auto;"></div>
<p>In theory, tags can have whatever meaning you attach to them (such as <code>&lt;people&gt;</code> or <code>&lt;occupation&gt;</code>). However, in practice there are hundreds of tags which are standard in websites (for example, <a href="https://www.w3schools.com/tags/">here</a>). If you’re just getting started, there’s no need for you to learn them but as you progress in web scraping, you’ll start to recognize them (one brief example is <code>&lt;strong&gt;</code> which simply <strong>bolds</strong> text in a website).</p>
<p>The <code>xml2</code> package was designed to read XML strings and to navigate the tree structure to extract information. For example, let’s read in the XML data from our fake example and look at its general structure:</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">xml_raw</span> <span class="op">&lt;-</span> <span class="fu"><a href="http://xml2.r-lib.org/reference/read_xml.html">read_xml</a></span><span class="op">(</span><span class="va">xml_test</span><span class="op">)</span>
<span class="fu"><a href="http://xml2.r-lib.org/reference/xml_structure.html">xml_structure</a></span><span class="op">(</span><span class="va">xml_raw</span><span class="op">)</span></code></pre></div>
<pre><code>## &lt;people&gt;
##   &lt;jason&gt;
##     &lt;person [type]&gt;
##       &lt;first_name&gt;
##         &lt;married&gt;
##           {text}
##       &lt;last_name&gt;
##         {text}
##       &lt;occupation&gt;
##         {text}
##   &lt;carol&gt;
##     &lt;person [type]&gt;
##       &lt;first_name&gt;
##         &lt;married&gt;
##           {text}
##       &lt;last_name&gt;
##         {text}
##       &lt;occupation&gt;
##         {text}</code></pre>
<p>You can see that the structure is tree-based, meaning that tags such as <code>&lt;jason&gt;</code> and <code>&lt;carol&gt;</code> are nested within the <code>&lt;people&gt;</code> tag. In XML jargon, <code>&lt;people&gt;</code> is the <strong>root node</strong>, whereas <code>&lt;jason&gt;</code> and <code>&lt;carol&gt;</code> are the <strong>child nodes</strong> from <code>&lt;people&gt;</code>.</p>
<p>In more detail, the structure is as follows:</p>
<ul>
<li>The <strong>root</strong> node is <code>&lt;people&gt;</code>
</li>
<li>The <strong>child</strong> nodes are <code>&lt;jason&gt;</code> and <code>&lt;carol&gt;</code>
</li>
<li>Then each <strong>child</strong> node has nodes <code>&lt;first_name&gt;</code>, <code>&lt;married&gt;</code>, <code>&lt;last_name&gt;</code> and <code>&lt;occupation&gt;</code> nested within them.</li>
</ul>
<p>Put another way, if something is nested within a <strong>node</strong>, then the nested node is a <strong>child</strong> of the upper-level node. In our example, the <strong>root</strong> node is <code>&lt;people&gt;</code> so we can check which are its children:</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># xml_child returns only one child (specified in search)</span>
<span class="co"># Here, jason is the first child</span>
<span class="fu"><a href="http://xml2.r-lib.org/reference/xml_children.html">xml_child</a></span><span class="op">(</span><span class="va">xml_raw</span>, search <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></code></pre></div>
<pre><code>## {xml_node}
## &lt;jason&gt;
## [1] &lt;person type="fictional"&gt;\n  &lt;first_name&gt;\n    &lt;married&gt;\n        Jason\n ...</code></pre>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Here, carol is the second child</span>
<span class="fu"><a href="http://xml2.r-lib.org/reference/xml_children.html">xml_child</a></span><span class="op">(</span><span class="va">xml_raw</span>, search <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></code></pre></div>
<pre><code>## {xml_node}
## &lt;carol&gt;
## [1] &lt;person type="real"&gt;\n  &lt;first_name&gt;\n    &lt;married&gt;\n        Carol\n      ...</code></pre>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Use xml_children to extract **all** children</span>
<span class="va">child_xml</span> <span class="op">&lt;-</span> <span class="fu"><a href="http://xml2.r-lib.org/reference/xml_children.html">xml_children</a></span><span class="op">(</span><span class="va">xml_raw</span><span class="op">)</span>

<span class="va">child_xml</span></code></pre></div>
<pre><code>## {xml_nodeset (2)}
## [1] &lt;jason&gt;\n  &lt;person type="fictional"&gt;\n    &lt;first_name&gt;\n      &lt;married&gt;\n ...
## [2] &lt;carol&gt;\n  &lt;person type="real"&gt;\n    &lt;first_name&gt;\n      &lt;married&gt;\n      ...</code></pre>
<p>Tags can also have different attributes which are usually specified as <code>&lt;fake_tag attribute='fake'&gt;</code> and ended as usual with <code>&lt;/fake_tag&gt;</code>. If you look at the XML structure of our example, you’ll notice that each <code>&lt;person&gt;</code> tag has an attribute called <code>type</code>. As you’ll see in our real-world example, extracting these attributes is often the aim of our scraping adventure. Using <code>xml2</code>, we can extract all attributes that match a specific name with <code>xml_attrs</code>.</p>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Extract the attribute type from all nodes</span>
<span class="fu"><a href="http://xml2.r-lib.org/reference/xml_attr.html">xml_attrs</a></span><span class="op">(</span><span class="va">child_xml</span>, <span class="st">"type"</span><span class="op">)</span></code></pre></div>
<pre><code>## [[1]]
## named character(0)
## 
## [[2]]
## named character(0)</code></pre>
<p>Wait, why didn’t this work? Well, if you look at the output of <code>child_xml</code>, we have two nodes on which are for <code>&lt;jason&gt;</code> and <code>&lt;carol&gt;</code>.</p>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">child_xml</span></code></pre></div>
<pre><code>## {xml_nodeset (2)}
## [1] &lt;jason&gt;\n  &lt;person type="fictional"&gt;\n    &lt;first_name&gt;\n      &lt;married&gt;\n ...
## [2] &lt;carol&gt;\n  &lt;person type="real"&gt;\n    &lt;first_name&gt;\n      &lt;married&gt;\n      ...</code></pre>
<p>Do these tags have an attribute? No, because if they did, they would have something like <code>&lt;jason type='fake_tag'&gt;</code>. What we need is to look down at the <code>&lt;person&gt;</code> tag within <code>&lt;jason&gt;</code> and <code>&lt;carol&gt;</code> and extract the attribute from <code>&lt;person&gt;</code>.</p>
<p>Does this sound familiar? Both <code>&lt;jason&gt;</code> and <code>&lt;carol&gt;</code> have an associated <code>&lt;person&gt;</code> tag below them, making them their children. We can just go down one level by running <code>xml_children</code> on these tags and extract them.</p>
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># We go down one level of children</span>
<span class="va">person_nodes</span> <span class="op">&lt;-</span> <span class="fu"><a href="http://xml2.r-lib.org/reference/xml_children.html">xml_children</a></span><span class="op">(</span><span class="va">child_xml</span><span class="op">)</span>

<span class="co"># &lt;person&gt; is now the main node, so we can extract attributes</span>
<span class="va">person_nodes</span></code></pre></div>
<pre><code>## {xml_nodeset (2)}
## [1] &lt;person type="fictional"&gt;\n  &lt;first_name&gt;\n    &lt;married&gt;\n        Jason\n ...
## [2] &lt;person type="real"&gt;\n  &lt;first_name&gt;\n    &lt;married&gt;\n        Carol\n      ...</code></pre>
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Both type attributes</span>
<span class="fu"><a href="http://xml2.r-lib.org/reference/xml_attr.html">xml_attrs</a></span><span class="op">(</span><span class="va">person_nodes</span>, <span class="st">"type"</span><span class="op">)</span></code></pre></div>
<pre><code>## [[1]]
##        type 
## "fictional" 
## 
## [[2]]
##   type 
## "real"</code></pre>
<p>Using the <code>xml_path</code> function you can even find the ‘address’ of these nodes to retrieve specific tags without having to write down <code>xml_children</code> many times. For example:</p>
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Specific address of each person tag for the whole xml tree</span>
<span class="co"># only using the `person_nodes`</span>
<span class="fu"><a href="http://xml2.r-lib.org/reference/xml_path.html">xml_path</a></span><span class="op">(</span><span class="va">person_nodes</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] "/people/jason/person" "/people/carol/person"</code></pre>
<p>We have the ‘address’ of specific tags in the tree but how do we extract them automatically? To extract specific ‘addresses’ of this XML tree, the main function we’ll use is <code>xml_find_all</code>. This function accepts the XML tree and an ‘address’ string. We can use very simple strings, such as the one given by <code>xml_path</code>:</p>
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># You can use results from xml_path like directories</span>
<span class="fu"><a href="http://xml2.r-lib.org/reference/xml_find_all.html">xml_find_all</a></span><span class="op">(</span><span class="va">xml_raw</span>, <span class="st">"/people/jason/person"</span><span class="op">)</span></code></pre></div>
<pre><code>## {xml_nodeset (1)}
## [1] &lt;person type="fictional"&gt;\n  &lt;first_name&gt;\n    &lt;married&gt;\n        Jason\n ...</code></pre>
<p>The expression above is asking for the node <code>"/people/jason/person"</code>. This will return the same as saying <code>xml_raw %&gt;% xml_child(search = 1)</code>. For deeply nested trees, <code>xml_find_all</code> will be many times much cleaner than calling <code>xml_child</code> recursively many times.</p>
<p>However, in most cases the ‘addresses’ used in <code>xml_find_all</code> come from a separate language called XPath (in fact, the ‘address’ we’ve been looking at <strong>is</strong> XPath). XPath is a complex language (such as regular expressions for strings) which is beyond this brief tutorial. However, with the examples we’ve seen so far, we can use some basic XPath which we’ll need later on.</p>
<p>To extract all the tags in a document, we can use <code>//name_of_tag</code>.</p>
<div class="sourceCode" id="cb45"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Search for all 'married' nodes</span>
<span class="fu"><a href="http://xml2.r-lib.org/reference/xml_find_all.html">xml_find_all</a></span><span class="op">(</span><span class="va">xml_raw</span>, <span class="st">"//married"</span><span class="op">)</span></code></pre></div>
<pre><code>## {xml_nodeset (2)}
## [1] &lt;married&gt;\n        Jason\n      &lt;/married&gt;
## [2] &lt;married&gt;\n        Carol\n      &lt;/married&gt;</code></pre>
<p>With the previous XPath, we’re searching for <strong>all</strong> married tags within the complete XML tree. The result returns all married nodes (I use the words tags and nodes interchangeably) in the complete tree structure. Another example would be finding all <code>&lt;occupation&gt;</code> tags:</p>
<div class="sourceCode" id="cb47"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="http://xml2.r-lib.org/reference/xml_find_all.html">xml_find_all</a></span><span class="op">(</span><span class="va">xml_raw</span>, <span class="st">"//occupation"</span><span class="op">)</span></code></pre></div>
<pre><code>## {xml_nodeset (2)}
## [1] &lt;occupation&gt;\n      Spy\n    &lt;/occupation&gt;
## [2] &lt;occupation&gt;\n      Scientist\n    &lt;/occupation&gt;</code></pre>
<p>If you want to find any other tag you can replace <code>"//occupation"</code> with your tag of interest and <code>xml_find_all</code> will find all of them.</p>
<p>If you wanted to find all tags <strong>below</strong> your current node, you only need to add a <code>.</code> at the beginning: <code>".//occupation"</code>. For example, if we dived into the <code>&lt;jason&gt;</code> tag and we wanted his <code>&lt;occupation&gt;</code> tag, <code>"//occupation"</code> will returns <strong>all</strong> <code>&lt;occupation&gt;</code> tags. Instead, <code>".//occupation"</code> will return only the found tags <strong>below</strong> the current tag. For example:</p>
<div class="sourceCode" id="cb49"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">xml_raw</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="co"># Dive only into Jason's tag</span>
  <span class="fu"><a href="http://xml2.r-lib.org/reference/xml_children.html">xml_child</a></span><span class="op">(</span>search <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="http://xml2.r-lib.org/reference/xml_find_all.html">xml_find_all</a></span><span class="op">(</span><span class="st">".//occupation"</span><span class="op">)</span></code></pre></div>
<pre><code>## {xml_nodeset (1)}
## [1] &lt;occupation&gt;\n      Spy\n    &lt;/occupation&gt;</code></pre>
<div class="sourceCode" id="cb51"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Instead, the wrong way would have been:</span>
<span class="va">xml_raw</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="co"># Dive only into Jason's tag</span>
  <span class="fu"><a href="http://xml2.r-lib.org/reference/xml_children.html">xml_child</a></span><span class="op">(</span>search <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="co"># Here we get both occupation tags</span>
  <span class="fu"><a href="http://xml2.r-lib.org/reference/xml_find_all.html">xml_find_all</a></span><span class="op">(</span><span class="st">"//occupation"</span><span class="op">)</span></code></pre></div>
<pre><code>## {xml_nodeset (2)}
## [1] &lt;occupation&gt;\n      Spy\n    &lt;/occupation&gt;
## [2] &lt;occupation&gt;\n      Scientist\n    &lt;/occupation&gt;</code></pre>
<p>The first example only returns <code>&lt;jason&gt;</code>’s occupation whereas the second returned <strong>all</strong> occupations, regardless of where you are in the tree.</p>
<p>XPath also allows you to identify tags that contain only one specific <strong>attribute</strong>, such as the one’s we saw earlier. For example, to filter all <code>&lt;person&gt;</code> tags with the attribute <code>filter</code> set to <code>fictional</code>, we could do it with:</p>
<div class="sourceCode" id="cb53"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Give me all the tags 'person' that have an attribute type='fictional'</span>
<span class="va">xml_raw</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="http://xml2.r-lib.org/reference/xml_find_all.html">xml_find_all</a></span><span class="op">(</span><span class="st">"//person[@type='fictional']"</span><span class="op">)</span></code></pre></div>
<pre><code>## {xml_nodeset (1)}
## [1] &lt;person type="fictional"&gt;\n  &lt;first_name&gt;\n    &lt;married&gt;\n        Jason\n ...</code></pre>
<p>If you wanted to do the same but for the tags <strong>below</strong> your current nodes, the same trick we learned earlier would work: <code>".//person[@type='fictional']"</code>. These are just some primers that can help you jump easily to using XPath, but I encourage you to look at other examples on the web, as complex websites often require complex XPath expressions.</p>
<p>Before we begin our real-word example, you might be asking yourself how you can actually <strong>extract</strong> the text/numeric data from these <strong>nodes</strong>. Well, that’s easy: <code>xml_text</code>.</p>
<div class="sourceCode" id="cb55"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">xml_raw</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="http://xml2.r-lib.org/reference/xml_find_all.html">xml_find_all</a></span><span class="op">(</span><span class="st">".//occupation"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="http://xml2.r-lib.org/reference/xml_text.html">xml_text</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] "\n      Spy\n    "       "\n      Scientist\n    "</code></pre>
<p>Once you’ve narrowed down your tree-based search to one single piece of text or numbers, <code><a href="http://xml2.r-lib.org/reference/xml_text.html">xml_text()</a></code> will extract that for you (there’s also <code>xml_double</code> and <code>xml_integer</code> for extracting numbers). As I said, XPath is really a huge language. If you’re interested, <a href="https://devhints.io/xpath">this</a> XPath cheat sheets have helped me a lot to learn tricks for easy scraping.</p>
</div>
<div id="real-world-example" class="section level2">
<h2>
<span class="header-section-number">5.2</span> Real-world example<a class="anchor" aria-label="anchor" href="#real-world-example"><i class="fas fa-link"></i></a>
</h2>
<p>We’re interested in making a list of many schools in Spain and visualizing their location. This can be useful for many things such as matching population density of children across different regions to school locations. The website <code>www.buscocolegio.com</code> contains a database of schools similar to what we’re looking for. As described at the beginning, instead we’re going to use <code>scrapex</code> which has the function <code><a href="https://rdrr.io/pkg/scrapex/man/spanish_schools_ex.html">spanish_schools_ex()</a></code> containing the links to a sample of websites from different schools saved locally on your computer.</p>
<p>Let’s look at an example for one school.</p>
<div class="sourceCode" id="cb57"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">school_links</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/scrapex/man/spanish_schools_ex.html">spanish_schools_ex</a></span><span class="op">(</span><span class="op">)</span>

<span class="co"># Keep only the HTML file of one particular school.</span>
<span class="va">school_url</span> <span class="op">&lt;-</span> <span class="va">school_links</span><span class="op">[</span><span class="fl">13</span><span class="op">]</span>

<span class="va">school_url</span></code></pre></div>
<pre><code>## [1] "/home/runner/.local/share/renv/cache/v5/R-4.2/x86_64-pc-linux-gnu/scrapex/0.0.1.9999/5f52b0cca7211cbdd54fe40a58a02568/scrapex/extdata/spanish_schools_ex/school_3006839.html"</code></pre>
<p>If you’re interested in looking at the website interactively in your browser, you can do it with <code>browseURL(prep_browser(school_url))</code>. Let’s read the HTML (XML and HTML are <strong>usually</strong> interchangeable, so here we use <code>read_html</code>).</p>
<div class="sourceCode" id="cb59"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Here we use `read_html` because `read_xml` is throwing an error</span>
<span class="co"># when attempting to read. However, everything we've discussed</span>
<span class="co"># should be the same.</span>
<span class="va">school_raw</span> <span class="op">&lt;-</span> <span class="fu"><a href="http://xml2.r-lib.org/reference/read_xml.html">read_html</a></span><span class="op">(</span><span class="va">school_url</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="http://xml2.r-lib.org/reference/xml_children.html">xml_child</a></span><span class="op">(</span><span class="op">)</span>

<span class="va">school_raw</span></code></pre></div>
<pre><code>## {html_node}
## &lt;head&gt;
##  [1] &lt;title&gt;Aquí encontrarás toda la información necesaria sobre CEIP SANCHIS ...
##  [2] &lt;meta charset="utf-8"&gt;\n
##  [3] &lt;meta name="viewport" content="width=device-width, initial-scale=1, shri ...
##  [4] &lt;meta http-equiv="x-ua-compatible" content="ie=edge"&gt;\n
##  [5] &lt;meta name="author" content="BuscoColegio"&gt;\n
##  [6] &lt;meta name="description" content="Encuentra toda la información necesari ...
##  [7] &lt;meta name="keywords" content="opiniones SANCHIS GUARNER, contacto SANCH ...
##  [8] &lt;link rel="shortcut icon" href="/favicon.ico"&gt;\n
##  [9] &lt;link rel="stylesheet" href="//fonts.googleapis.com/css?family=Roboto+Sl ...
## [10] &lt;link rel="stylesheet" href="https://s3.eu-west-3.amazonaws.com/buscocol ...
## [11] &lt;link rel="stylesheet" href="/assets/vendor/icon-awesome/css/font-awesom ...
## [12] &lt;link rel="stylesheet" href="/assets/vendor/icon-line/css/simple-line-ic ...
## [13] &lt;link rel="stylesheet" href="/assets/vendor/icon-line-pro/style.css"&gt;\n
## [14] &lt;link rel="stylesheet" href="/assets/vendor/icon-hs/style.css"&gt;\n
## [15] &lt;link rel="stylesheet" href="https://s3.eu-west-3.amazonaws.com/buscocol ...
## [16] &lt;link rel="stylesheet" href="https://s3.eu-west-3.amazonaws.com/buscocol ...
## [17] &lt;link rel="stylesheet" href="https://s3.eu-west-3.amazonaws.com/buscocol ...
## [18] &lt;link rel="stylesheet" href="https://s3.eu-west-3.amazonaws.com/buscocol ...
## [19] &lt;link rel="stylesheet" href="https://s3.eu-west-3.amazonaws.com/buscocol ...
## [20] &lt;link rel="stylesheet" href="https://s3.eu-west-3.amazonaws.com/buscocol ...
## ...</code></pre>
<p>Web scraping strategies are very specific to the website you’re after. You have to get very familiar with the website you’re interested to be able to match perfectly the information you’re looking for. In many cases, scraping two websites will require vastly different strategies. For this particular example, we’re only interested in figuring out the <strong>location</strong> of each school so we only have to extract its location.</p>
<div class="inline-figure"><img src="images/cs_spanish_school_locations/buscocolegios_xml/main_page.png" width="100%" style="display: block; margin: auto;"></div>
<p><br></p>
<p>In the image above you’ll find a typical school’s website in <code>wwww.buscocolegio.com</code>. The website has a lot of information, but we’re only interested in the button that is circled by the orange rectangle. If you can’t find it easily, it’s below the Google Maps on the right which says “Buscar colegio cercano”.</p>
<p>When you click on this button, this actually points you towards the coordinates of the school so we just have to find a way of figuring out how to click this button or figure out how to get its information. All browsers allow you to do this if you press CTRL + SHIFT + c at the same time (Firefox and Chrome support this hotkey). If a window on the right popped in full of code, then you’re on the right track:</p>
<p><br></p>
<div class="inline-figure"><img src="images/cs_spanish_school_locations/buscocolegios_xml/developer_tools.png" width="100%" style="display: block; margin: auto;"></div>
<p><br></p>
<p>Here we can search the source code of the website. If you place your mouse pointer over the lines of code from this right-most window, you’ll see sections of the website being highlighted in blue. This indicates which parts of the code refer to which parts of the website. Luckily for us, we don’t have to search the complete source code to find that specific location. We can approximate our search by typing the text we’re looking for in the search bar at the top of the right window:</p>
<p><br></p>
<div class="inline-figure"><img src="images/cs_spanish_school_locations/buscocolegios_xml/search_developer_tools.png" width="100%" style="display: block; margin: auto;"></div>
<p><br></p>
<p>After we click enter, we’ll be automatically directed to the tag that has the information that we want.</p>
<p><br></p>
<div class="inline-figure"><img src="images/cs_spanish_school_locations/buscocolegios_xml/location_tag.png" width="100%" style="display: block; margin: auto;"></div>
<p><br></p>
<p>More specifically, we can see that the latitude and longitude of schools are found in an attributed called <code>href</code> in a tag <code>&lt;a&gt;</code>:</p>
<p><br></p>
<div class="inline-figure"><img src="images/cs_spanish_school_locations/buscocolegios_xml/location_tag_zoomed.png" width="100%" style="display: block; margin: auto;"></div>
<p><br></p>
<p>Can you see the latitude and longitude fields in the text highlighted blue? It’s hidden in-between words. That is precisely the type of information we’re after. Extracting all <code>&lt;a&gt;</code> tags from the website (hint: XPath similar to <code>"//a"</code>) will yield hundreds of matches because <code>&lt;a&gt;</code> is a very common tag. Moreover, refining the search to <code>&lt;a&gt;</code> tags which have an <code>href</code> attribute will also yield hundreds of matches because <code>href</code> is the standard attribute to attach links within websites. We need to narrow down our search within the website.</p>
<p>One strategy is to find the ‘father’ or ‘grandfather’ node of this particular <code>&lt;a&gt;</code> tag and then match a node which has that same sequence of grandfather -&gt; father -&gt; child node. By looking at the structure of this small XML snippet from the right-most window, we see that the ‘grandfather’ of this <code>&lt;a&gt;</code> tag is <code>&lt;p class="d-flex align-items-baseline g-mt-5'&gt;</code> which has a particularly long attribute named <code>class</code>.</p>
<p><br></p>
<div class="inline-figure"><img src="images/cs_spanish_school_locations/buscocolegios_xml/location_tag_zoomed.png" width="100%" style="display: block; margin: auto;"></div>
<p><br></p>
<p>Don’t be intimidated by these tag names and long attributes. I also don’t know what any of these attributes mean. But what I do know is that this is the ‘grandfather’ of the <code>&lt;a&gt;</code> tag I’m interested in. So using our XPath skills, let’s search for that <code>&lt;p&gt;</code> tag and see if we get only one match.</p>
<div class="sourceCode" id="cb61"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Search for all &lt;p&gt; tags with that class in the document</span>
<span class="va">school_raw</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="http://xml2.r-lib.org/reference/xml_find_all.html">xml_find_all</a></span><span class="op">(</span><span class="st">"//p[@class='d-flex align-items-baseline g-mt-5']"</span><span class="op">)</span></code></pre></div>
<pre><code>## {xml_nodeset (1)}
## [1] &lt;p class="d-flex align-items-baseline g-mt-5"&gt;\r\n\t                    &lt; ...</code></pre>
<p>Only one match, so this is good news. This means that we can uniquely identify this particular <code>&lt;p&gt;</code> tag. Let’s refine the search to say: Find all <code>&lt;a&gt;</code> tags which are children of that specific <code>&lt;p&gt;</code> tag. This only means I’ll add a <code>"//a"</code> to the previous expression. Since there is only one <code>&lt;p&gt;</code> tag with the class, we’re interested in checking whether there is more than one <code>&lt;a&gt;</code> tag below this <code>&lt;p&gt;</code> tag.</p>
<div class="sourceCode" id="cb63"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">school_raw</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="http://xml2.r-lib.org/reference/xml_find_all.html">xml_find_all</a></span><span class="op">(</span><span class="st">"//p[@class='d-flex align-items-baseline g-mt-5']//a"</span><span class="op">)</span></code></pre></div>
<pre><code>## {xml_nodeset (1)}
## [1] &lt;a href="/Colegio/buscar-colegios-cercanos.action?colegio.latitud=38.8274 ...</code></pre>
<p>There we go! We can see the specific <code>href</code> that contains the latitude and longitude data we’re interested in. How do we extract the <code>href</code> attribute? Using <code>xml_attr</code> as we did before!</p>
<div class="sourceCode" id="cb65"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">location_str</span> <span class="op">&lt;-</span>
  <span class="va">school_raw</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="http://xml2.r-lib.org/reference/xml_find_all.html">xml_find_all</a></span><span class="op">(</span><span class="st">"//p[@class='d-flex align-items-baseline g-mt-5']//a"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="http://xml2.r-lib.org/reference/xml_attr.html">xml_attr</a></span><span class="op">(</span>attr <span class="op">=</span> <span class="st">"href"</span><span class="op">)</span>

<span class="va">location_str</span></code></pre></div>
<pre><code>## [1] "/Colegio/buscar-colegios-cercanos.action?colegio.latitud=38.8274492&amp;colegio.longitud=0.0221681"</code></pre>
<p>Ok, now we need some regex skills to get only the latitude and longitude (regex expressions are used to search for patterns inside a string, such as for example a date. See <a href="https://www.jumpingrivers.com/blog/regular-expressions-every-r-programmer-should-know/">here</a> for some examples):</p>
<div class="sourceCode" id="cb67"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">location</span> <span class="op">&lt;-</span>
  <span class="va">location_str</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_extract.html">str_extract_all</a></span><span class="op">(</span><span class="st">"=.+$"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_replace.html">str_replace_all</a></span><span class="op">(</span><span class="st">"=|colegio\\.longitud"</span>, <span class="st">""</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_split.html">str_split</a></span><span class="op">(</span><span class="st">"&amp;"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="va">.</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>

<span class="va">location</span></code></pre></div>
<pre><code>## [1] "38.8274492" "0.0221681"</code></pre>
<p>Ok, so we got the information we needed for one single school. Let’s turn that into a function so we can pass only the school’s link and get the coordinates back.</p>
<p>Before we do that, I will set something called my <code>User-Agent</code>. In short, the <code>User-Agent</code> is <strong>who</strong> you are. It is good practice to identify the person who is scraping the website because if you’re causing any trouble on the website, the website can directly identify who is causing problems. You can figure out your user agent <a href="https://www.google.com/search?client=ubuntu&amp;channel=fs&amp;q=what%27s+my+user+agent&amp;ie=utf-8&amp;oe=utf-8">here</a> and paste it in the string below. In addition, I will add a time sleep of 5 seconds to the function because we want to make sure we don’t cause any troubles to the website we’re scraping due to an overload of requests.</p>
<div class="sourceCode" id="cb69"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># This sets your `User-Agent` globally so that all requests are</span>
<span class="co"># identified with this `User-Agent`</span>
<span class="fu"><a href="https://httr.r-lib.org/reference/set_config.html">set_config</a></span><span class="op">(</span>
  <span class="fu"><a href="https://httr.r-lib.org/reference/user_agent.html">user_agent</a></span><span class="op">(</span><span class="st">"Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:70.0) Gecko/20100101 Firefox/70.0"</span><span class="op">)</span>
<span class="op">)</span>

<span class="co"># Collapse all of the code from above into one function called</span>
<span class="co"># school grabber</span>

<span class="va">school_grabber</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">school_url</span><span class="op">)</span> <span class="op">{</span>
  <span class="co"># We add a time sleep of 5 seconds to avoid</span>
  <span class="co"># sending too many quick requests to the website</span>
  <span class="fu"><a href="https://rdrr.io/r/base/Sys.sleep.html">Sys.sleep</a></span><span class="op">(</span><span class="fl">5</span><span class="op">)</span>

  <span class="va">school_raw</span> <span class="op">&lt;-</span> <span class="fu"><a href="http://xml2.r-lib.org/reference/read_xml.html">read_html</a></span><span class="op">(</span><span class="va">school_url</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="http://xml2.r-lib.org/reference/xml_children.html">xml_child</a></span><span class="op">(</span><span class="op">)</span>

  <span class="va">location_str</span> <span class="op">&lt;-</span>
    <span class="va">school_raw</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
    <span class="fu"><a href="http://xml2.r-lib.org/reference/xml_find_all.html">xml_find_all</a></span><span class="op">(</span><span class="st">"//p[@class='d-flex align-items-baseline g-mt-5']//a"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
    <span class="fu"><a href="http://xml2.r-lib.org/reference/xml_attr.html">xml_attr</a></span><span class="op">(</span>attr <span class="op">=</span> <span class="st">"href"</span><span class="op">)</span>

  <span class="va">location</span> <span class="op">&lt;-</span>
    <span class="va">location_str</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
    <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_extract.html">str_extract_all</a></span><span class="op">(</span><span class="st">"=.+$"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
    <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_replace.html">str_replace_all</a></span><span class="op">(</span><span class="st">"=|colegio\\.longitud"</span>, <span class="st">""</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
    <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_split.html">str_split</a></span><span class="op">(</span><span class="st">"&amp;"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
    <span class="va">.</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>

  <span class="co"># Turn into a data frame</span>
  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>
    latitude <span class="op">=</span> <span class="va">location</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,
    longitude <span class="op">=</span> <span class="va">location</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>,
    stringsAsFactors <span class="op">=</span> <span class="cn">FALSE</span>
  <span class="op">)</span>
<span class="op">}</span>


<span class="fu">school_grabber</span><span class="op">(</span><span class="va">school_url</span><span class="op">)</span></code></pre></div>
<pre><code>##     latitude longitude
## 1 38.8274492 0.0221681</code></pre>
<p>Ok, so it’s working. The only thing left is to extract this for many schools. As shown earlier, <code>scrapex</code> contains a list of 27 school links that we can automatically scrape. Let’s loop over those, get the information of coordinates for each and collapse all of them into a data frame.</p>
<div class="sourceCode" id="cb71"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map_dfr</a></span><span class="op">(</span><span class="va">school_links</span>, <span class="va">school_grabber</span><span class="op">)</span>
<span class="va">res</span></code></pre></div>
<pre><code>##    latitude  longitude
## 1  42.72779 -8.6567935
## 2  43.24439 -8.8921645
## 3  38.95592 -1.2255769
## 4  39.18657 -1.6225903
## 5  40.38245 -3.6410388
## 6  40.22929 -3.1106322
## 7  40.43860 -3.6970366
## 8  40.33514 -3.5155669
## 9  40.50546 -3.3738441
## 10 40.63826 -3.4537107
## 11 40.38543 -3.6639500
## 12 37.76485 -1.5030467
## 13 38.82745  0.0221681
## 14 40.99434 -5.6224391
## 15 40.99434 -5.6224391
## 16 40.56037 -5.6703725
## 17 40.99434 -5.6224391
## 18 40.99434 -5.6224391
## 19 41.13593  0.9901905
## 20 41.26155  1.1670507
## 21 41.22851  0.5461471
## 22 41.14580  0.8199749
## 23 41.18341  0.5680564
## 24 42.07820  1.8203155
## 25 42.25245  1.8621546
## 26 41.73767  1.8383666
## 27 41.62345  2.0013628</code></pre>
<p>So now that we have the locations of these schools, let’s plot them:</p>
<div class="sourceCode" id="cb73"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate_all.html">mutate_all</a></span><span class="op">(</span><span class="va">res</span>, <span class="va">as.numeric</span><span class="op">)</span>

<span class="va">sp_sf</span> <span class="op">&lt;-</span>
  <span class="fu"><a href="https://rdrr.io/pkg/rnaturalearth/man/ne_countries.html">ne_countries</a></span><span class="op">(</span>scale <span class="op">=</span> <span class="st">"large"</span>, country <span class="op">=</span> <span class="st">"Spain"</span>, returnclass <span class="op">=</span> <span class="st">"sf"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html">st_transform</a></span><span class="op">(</span>crs <span class="op">=</span> <span class="fl">4326</span><span class="op">)</span>

<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">sp_sf</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">res</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">longitude</span>, y <span class="op">=</span> <span class="va">latitude</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">coord_sf</a></span><span class="op">(</span>xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">20</span>, <span class="fl">10</span><span class="op">)</span>, ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">25</span>, <span class="fl">45</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_minimal</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span><span class="op">(</span><span class="st">"Sample of schools in Spain"</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="images/cs_spanish_school_locations/automatic_rmarkdown/spain-map-schools-1.png" width="672" style="display: block; margin: auto;"></div>
<p>There we go! We went from literally no information at the beginning of this tutorial to interpretable and summarized information only using web data. We can see some schools in Madrid (center) as well in other regions of Spain, including Catalonia and Galicia.</p>
<p>This marks the end of our scraping adventure but before we finish, I want to mention some of the ethical guidelines for web scraping. Scraping is extremely useful for us but can give headaches to other people maintaining the website of interest. Here’s a list of ethical guidelines you should always follow:</p>
<ul>
<li><p>Read the terms and services: many websites prohibit web scraping and you could be in a breach of privacy by scraping the data. <a href="https://fortune.com/2016/05/18/okcupid-data-research/">One</a> famous example.</p></li>
<li><p>Check the <code>robots.txt</code> file. This is a file that most websites have (<code>www.buscocolegio.com</code> does <strong>not</strong>) which tell you which specific paths inside the website are scrapable and which are not. See <a href="https://www.robotstxt.org/robotstxt.html">here</a> for an explanation of what robots.txt look like and where to find them.</p></li>
<li><p>Some websites are supported by very big servers, which means you can send 4-5 website requests per second. Others, such as <code>www.buscocolegio.com</code> are not. It’s good practice to always put a time sleep between your requests. In our example, I set it to 5 seconds because this is a small website and we don’t want to crash their servers.</p></li>
<li><p>When making requests, there are computational ways of identifying yourself. For example, every request (such as the one’s we do) can have something called a <code>User-Agent</code>. It is good practice to include yourself in as the <code>User-Agent</code> (as we did in our code) because the admin of the server can directly identify if someone’s causing problems due to their web scraping.</p></li>
<li><p>Limit your scraping to non-busy hours such as overnight. This can help reduce the chances of collapsing the website since fewer people are visiting websites in the evening.</p></li>
</ul>
<p>You can read more about these ethical issues <a href="http://robertorocha.info/on-the-ethics-of-web-scraping/">here</a>.</p>
</div>
<div id="wrap-up" class="section level2">
<h2>
<span class="header-section-number">5.3</span> Wrap up<a class="anchor" aria-label="anchor" href="#wrap-up"><i class="fas fa-link"></i></a>
</h2>
<p>This tutorial introduced you to basic concepts in web scraping and applied them in a real-world setting. Web scraping is a vast field in computer science (you can find entire books on the subject such as <a href="https://www.apress.com/gp/book/9781484235812">this</a>). We covered some basic techniques which I think can take you a long way but there’s definitely more to learn. For those curious about where to turn, I’m looking forward to the upcoming book <a href="https://rud.is/b/books/">“A Field Guide for Web Scraping and Accessing APIs with R”</a> by Bob Rudis, which should be released in the near future. Now go scrape some websites ethically!</p>

</div>
</div>
  <div class="chapter-nav">
<div class="prev"><a href="data-formats-for-webscraping.html"><span class="header-section-number">4</span> Data Formats for Webscraping</a></div>
<div class="next"><a href="footnotes-and-citations.html"><span class="header-section-number">6</span> Footnotes and citations</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#case-study-scraping-spanish-school-locations-from-the-web"><span class="header-section-number">5</span> Case study: scraping Spanish school locations from the web</a></li>
<li><a class="nav-link" href="#basic-steps"><span class="header-section-number">5.1</span> Basic steps</a></li>
<li><a class="nav-link" href="#real-world-example"><span class="header-section-number">5.2</span> Real-world example</a></li>
<li><a class="nav-link" href="#wrap-up"><span class="header-section-number">5.3</span> Wrap up</a></li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
<li><a id="book-source" href="https://github.com/cimentadaj/dataharvesting/tree/main/book/blob/main/04-cs_spanish_school_locations.Rmd">View source <i class="fab fa-github"></i></a></li>
          <li><a id="book-edit" href="https://github.com/cimentadaj/dataharvesting/tree/main/book/edit/main/04-cs_spanish_school_locations.Rmd">Edit this page <i class="fab fa-github"></i></a></li>
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>Data Harvesting with R</strong>" was written by Jorge Cimentada. It was last built on 2022-06-13.</p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer>
</body>
</html>

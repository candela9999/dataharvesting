<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.313">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Jorge Cimentada">

<title>Case study: Scraping Spanish school locations from the web</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="case_study_spanish_schools_files/libs/clipboard/clipboard.min.js"></script>
<script src="case_study_spanish_schools_files/libs/quarto-html/quarto.js"></script>
<script src="case_study_spanish_schools_files/libs/quarto-html/popper.min.js"></script>
<script src="case_study_spanish_schools_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="case_study_spanish_schools_files/libs/quarto-html/anchor.min.js"></script>
<link href="case_study_spanish_schools_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="case_study_spanish_schools_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="case_study_spanish_schools_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="case_study_spanish_schools_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="case_study_spanish_schools_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">


</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Case study: Scraping Spanish school locations from the web</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Jorge Cimentada </p>
          </div>
  </div>
    
  
    
  </div>
  

</header>

<div class="cell">

</div>
<section id="case-study-scraping-spanish-school-locations-from-the-web" class="level2">
<h2 class="anchored" data-anchor-id="case-study-scraping-spanish-school-locations-from-the-web">Case study: Scraping Spanish school locations from the web</h2>
<p>Goal:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/spain-map-schools-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</section>
<section id="scraping-spanish-school-locations" class="level2">
<h2 class="anchored" data-anchor-id="scraping-spanish-school-locations">Scraping Spanish school locations</h2>
<p><code>www.buscocolegio.com</code> is saved locally on the <code>scrapex</code> package in the function <code>spanish_schools_ex()</code>:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(scrapex)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(<span class="fu">spanish_schools_ex</span>(), <span class="at">n =</span> <span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "/home/jorge.cimentada/personal_repos/dataharvesting/book/renv/library/R-4.2/x86_64-pc-linux-gnu/scrapex/extdata/spanish_schools_ex/school_15012626.html"
[2] "/home/jorge.cimentada/personal_repos/dataharvesting/book/renv/library/R-4.2/x86_64-pc-linux-gnu/scrapex/extdata/spanish_schools_ex/school_15013308.html"
[3] "/home/jorge.cimentada/personal_repos/dataharvesting/book/renv/library/R-4.2/x86_64-pc-linux-gnu/scrapex/extdata/spanish_schools_ex/school_2009122.html" </code></pre>
</div>
</div>
<p>These are the links to the landing page of each school inside the website. There are 27 schools saved locally.</p>
</section>
<section id="scraping-spanish-school-locations-1" class="level2">
<h2 class="anchored" data-anchor-id="scraping-spanish-school-locations-1">Scraping Spanish school locations</h2>
<p>Let’s see how one school website looks like:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(xml2)</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(httr)</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sf)</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rnaturalearth)</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(scrapex)</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>school_links <span class="ot">&lt;-</span> <span class="fu">spanish_schools_ex</span>()</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>school_url <span class="ot">&lt;-</span> school_links[<span class="dv">13</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">browseURL</span>(<span class="fu">prep_browser</span>(school_url))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="scraping-spanish-school-locations-2" class="level2">
<h2 class="anchored" data-anchor-id="scraping-spanish-school-locations-2">Scraping Spanish school locations</h2>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/main_website_no_selection-01.png" class="img-fluid figure-img"></p>
</figure>
</div>
</section>
<section id="build-a-scraper-for-one-school" class="level2">
<h2 class="anchored" data-anchor-id="build-a-scraper-for-one-school">Build a scraper for one school</h2>
<p>Read it into R:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>school_raw <span class="ot">&lt;-</span> <span class="fu">read_html</span>(school_url) <span class="sc">%&gt;%</span> <span class="fu">xml_child</span>()</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>school_raw</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>{html_node}
&lt;head&gt;
 [1] &lt;title&gt;Aquí encontrarás toda la información necesaria sobre CEIP SANCHIS ...
 [2] &lt;meta charset="utf-8"&gt;\n
 [3] &lt;meta name="viewport" content="width=device-width, initial-scale=1, shri ...
 [4] &lt;meta http-equiv="x-ua-compatible" content="ie=edge"&gt;\n
 [5] &lt;meta name="author" content="BuscoColegio"&gt;\n
 [6] &lt;meta name="description" content="Encuentra toda la información necesari ...
 [7] &lt;meta name="keywords" content="opiniones SANCHIS GUARNER, contacto SANCH ...
 [8] &lt;link rel="shortcut icon" href="/favicon.ico"&gt;\n
 [9] &lt;link rel="stylesheet" href="//fonts.googleapis.com/css?family=Roboto+Sl ...
[10] &lt;link rel="stylesheet" href="https://s3.eu-west-3.amazonaws.com/buscocol ...
[11] &lt;link rel="stylesheet" href="/assets/vendor/icon-awesome/css/font-awesom ...
[12] &lt;link rel="stylesheet" href="/assets/vendor/icon-line/css/simple-line-ic ...
[13] &lt;link rel="stylesheet" href="/assets/vendor/icon-line-pro/style.css"&gt;\n
[14] &lt;link rel="stylesheet" href="/assets/vendor/icon-hs/style.css"&gt;\n
[15] &lt;link rel="stylesheet" href="https://s3.eu-west-3.amazonaws.com/buscocol ...
[16] &lt;link rel="stylesheet" href="https://s3.eu-west-3.amazonaws.com/buscocol ...
[17] &lt;link rel="stylesheet" href="https://s3.eu-west-3.amazonaws.com/buscocol ...
[18] &lt;link rel="stylesheet" href="https://s3.eu-west-3.amazonaws.com/buscocol ...
[19] &lt;link rel="stylesheet" href="https://s3.eu-west-3.amazonaws.com/buscocol ...
[20] &lt;link rel="stylesheet" href="https://s3.eu-west-3.amazonaws.com/buscocol ...
...</code></pre>
</div>
</div>
</section>
<section id="build-a-scraper-for-one-school-1" class="level2">
<h2 class="anchored" data-anchor-id="build-a-scraper-for-one-school-1">Build a scraper for one school</h2>
<ul>
<li><p>Objective: extract school locations.</p></li>
<li><p>You always want to begin by browsing the source code on your browser</p></li>
<li><p>Exploring the output of <code>read_html</code> is not the best way to explore what you’re looking for</p></li>
<li><p>Get very familiar with the website. Scraping two websites will require vastly different strategies.</p></li>
<li><p>We’ll use the developers tool from your browser: <code>CTRL + SHIFT + c</code></p></li>
</ul>
</section>
<section id="build-a-scraper-for-one-school-2" class="level2">
<h2 class="anchored" data-anchor-id="build-a-scraper-for-one-school-2">Build a scraper for one school</h2>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/developer_tools.png" class="img-fluid figure-img"></p>
</figure>
</div>
</section>
<section id="build-a-scraper-for-one-school-3" class="level2">
<h2 class="anchored" data-anchor-id="build-a-scraper-for-one-school-3">Build a scraper for one school</h2>
<p>This is like an open book. You need to search and explore what you’re looking for. This is unstructured in nature. First intuition: look for the source code close to the map:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/main_page.png" class="img-fluid figure-img"></p>
</figure>
</div>
</section>
<section id="build-a-scraper-for-one-school-4" class="level2">
<h2 class="anchored" data-anchor-id="build-a-scraper-for-one-school-4">Build a scraper for one school</h2>
<p><code>CTRL + F</code> will pop up a search bar as other browsers. Search for terms next to what you’re looking for:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/search_developer_tools.png" class="img-fluid figure-img"></p>
</figure>
</div>
</section>
<section id="build-a-scraper-for-one-school-5" class="level2">
<h2 class="anchored" data-anchor-id="build-a-scraper-for-one-school-5">Build a scraper for one school</h2>
<p>Fast track to what we’re looking for:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/location_tag_zoomed.png" class="img-fluid figure-img"></p>
</figure>
</div>
</section>
<section id="build-a-scraper-for-one-school-6" class="level2">
<h2 class="anchored" data-anchor-id="build-a-scraper-for-one-school-6">Build a scraper for one school</h2>
<p>Remember, we’re just looking at the source code of the maps section:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/main_page.png" class="img-fluid figure-img"></p>
</figure>
</div>
</section>
<section id="build-a-scraper-for-one-school-7" class="level2">
<h2 class="anchored" data-anchor-id="build-a-scraper-for-one-school-7">Build a scraper for one school</h2>
<p>In case you didn’t know, the coordinates are hidden in a string inside the <code>href</code> tag:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/location_tag_zoomed.png" class="img-fluid figure-img"></p>
</figure>
</div>
</section>
<section id="build-a-scraper-for-one-school-8" class="level2">
<h2 class="anchored" data-anchor-id="build-a-scraper-for-one-school-8">Build a scraper for one school</h2>
<p>Typical brain storming:</p>
<ol type="1">
<li>Extract a unique tag?</li>
<li>Extract a common tag but with a unique attribute?</li>
<li>Extract a common tag but filtering through the ascendants of that tag?</li>
<li>Extract only filtering by text of an attribute, regardless of the tag?</li>
</ol>
<p><strong>There are many different ways to get what you’re looking for. XPath is very handy for this</strong> 👏.</p>
</section>
<section id="build-a-scraper-for-one-school-9" class="level2">
<h2 class="anchored" data-anchor-id="build-a-scraper-for-one-school-9">Build a scraper for one school</h2>
<p>We’ll go with option 3:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/father_p_tag.png" class="img-fluid figure-img"></p>
</figure>
</div>
</section>
<section id="build-a-scraper-for-one-school-10" class="level2">
<h2 class="anchored" data-anchor-id="build-a-scraper-for-one-school-10">Build a scraper for one school</h2>
<ul>
<li><p>Tag <code>&lt;p&gt;</code> with a descendant <code>&lt;a&gt;</code> will return too many results</p></li>
<li><p>We can combine option 3 with option 2: Tag <code>&lt;p&gt;</code> with a unique text attribute with a descendant <code>&lt;a&gt;</code>.</p></li>
<li><p>Possible XPath: find all <code>p</code> tags with <code>class</code> set to <code>d-flex align-items-baseline g-mt-5</code>. If we get one match, we’re on the right track:</p></li>
</ul>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Search for all &lt;p&gt; tags with that class in the document</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>school_raw <span class="sc">%&gt;%</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xml_find_all</span>(<span class="st">"//p[@class='d-flex align-items-baseline g-mt-5']"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>{xml_nodeset (1)}
[1] &lt;p class="d-flex align-items-baseline g-mt-5"&gt;\r\n\t                    &lt; ...</code></pre>
</div>
</div>
</section>
<section id="build-a-scraper-for-one-school-11" class="level2">
<h2 class="anchored" data-anchor-id="build-a-scraper-for-one-school-11">Build a scraper for one school</h2>
<ul>
<li><p>Extend XPath to say: find all <code>a</code> tags which are children of a <code>p</code> tag with <code>class</code> set to <code>d-flex align-items-baseline g-mt-5</code>.</p></li>
<li><p>Or in other words: append <code>//a</code> to the previous XPath</p></li>
</ul>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Search for all &lt;p&gt; tags with that class in the document</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>school_raw <span class="sc">%&gt;%</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xml_find_all</span>(<span class="st">"//p[@class='d-flex align-items-baseline g-mt-5']//a"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>{xml_nodeset (1)}
[1] &lt;a href="/Colegio/buscar-colegios-cercanos.action?colegio.latitud=38.8274 ...</code></pre>
</div>
</div>
<p>There we are, we can see the coordinates 👏</p>
</section>
<section id="build-a-scraper-for-one-school-12" class="level2">
<h2 class="anchored" data-anchor-id="build-a-scraper-for-one-school-12">Build a scraper for one school</h2>
<ul>
<li><p>Extract <code>href</code> attribute with <code>xml_attr</code>:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>location_str <span class="ot">&lt;-</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>  school_raw <span class="sc">%&gt;%</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xml_find_all</span>(<span class="st">"//p[@class='d-flex align-items-baseline g-mt-5']//a"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xml_attr</span>(<span class="at">attr =</span> <span class="st">"href"</span>)</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>location_str</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "/Colegio/buscar-colegios-cercanos.action?colegio.latitud=38.8274492&amp;colegio.longitud=0.0221681"</code></pre>
</div>
</div></li>
</ul>
<p>Awesome, but now we need some ninja string skills to extract the coordinates.</p>
</section>
<section id="data-cleaning" class="level2">
<h2 class="anchored" data-anchor-id="data-cleaning">Data Cleaning</h2>
<p>We need some regex skills to extract this. Let’s brain storming:</p>
<ol type="1">
<li>First coordinate appears after the first <code>=</code></li>
<li>There’s a few words like ‘colegio’ (this is just Spanish for school) and ‘longitud’ that are in the middle of the two coordinates.</li>
<li>A s<em>ingle</em> regex need not do all the work. Do it one step at a time.</li>
<li>One first step would be: extract any text after the <code>=</code> until the end of the string</li>
</ol>
</section>
<section id="data-cleaning-1" class="level2">
<h2 class="anchored" data-anchor-id="data-cleaning-1">Data Cleaning</h2>
<p>Possible regex: <code>"=.+$"</code> which captures a <code>=</code> followed by any character (the <code>.</code>) repeated 1 or more times (<code>+</code>) until the end of the string (<code>$</code>). Let’s test it:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>location <span class="ot">&lt;-</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>  location_str <span class="sc">%&gt;%</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">str_extract_all</span>(<span class="st">"=.+$"</span>)</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>location</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[[1]]
[1] "=38.8274492&amp;colegio.longitud=0.0221681"</code></pre>
</div>
</div>
<p>There we go!</p>
</section>
<section id="data-cleaning-2" class="level2">
<h2 class="anchored" data-anchor-id="data-cleaning-2">Data Cleaning</h2>
<p>Now we need to replace all unwanted letters in the strings. One way would be to say:</p>
<ul>
<li><p>Replace the <code>=</code> or <code>colegio.longitud</code> with an empty string.</p></li>
<li><p>Why not replace the <code>&amp;</code> as well? Because we can split the string based on <code>&amp;</code> later</p></li>
</ul>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>location <span class="ot">&lt;-</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>  location <span class="sc">%&gt;%</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">str_replace_all</span>(<span class="st">"=|colegio</span><span class="sc">\\</span><span class="st">.longitud"</span>, <span class="st">""</span>)</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>location</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "38.8274492&amp;0.0221681"</code></pre>
</div>
</div>
</section>
<section id="data-cleaning-3" class="level2">
<h2 class="anchored" data-anchor-id="data-cleaning-3">Data Cleaning</h2>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>location <span class="ot">&lt;-</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>  location <span class="sc">%&gt;%</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">str_split</span>(<span class="st">"&amp;"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>  .[[<span class="dv">1</span>]]</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>location</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "38.8274492" "0.0221681" </code></pre>
</div>
</div>
<p>Great, that’s it, this is data we’ve looking for in the entire chapter. Let’s summarize the work so far:</p>
<ul>
<li><p>Using XPath to extract tags that match our data</p></li>
<li><p>Clean up the data with some regex</p></li>
<li><p>Only do this for a <em>single</em> school since it’s much easier</p></li>
</ul>
</section>
<section id="scaling-the-scraper-to-all-schools" class="level2">
<h2 class="anchored" data-anchor-id="scaling-the-scraper-to-all-schools">Scaling the scraper to all schools</h2>
<ul>
<li><p>When scraping repetitively similar pages, it always makes sense to start small.</p></li>
<li><p>Focus your efforts on a single school</p></li>
<li><p>Wrap all your work into a function that works for that single school</p></li>
<li><p>Loop over all other schools applying the tested function</p></li>
<li><p>Set your <code>User-Agent</code> to identify yourself</p></li>
</ul>
</section>
<section id="scaling-the-scraper-to-all-schools-1" class="level2">
<h2 class="anchored" data-anchor-id="scaling-the-scraper-to-all-schools-1">Scaling the scraper to all schools</h2>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># This sets your `User-Agent` globally so that all requests are identified with this `User-Agent`</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="fu">set_config</span>(</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">user_agent</span>(<span class="st">"Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:105.0) Gecko/20100101 Firefox/105.0; Jorge Cimentada / cimentadaj@gmail.com"</span>)</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Collapse all of the code from above into one function called</span></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a><span class="co"># school grabber</span></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>school_grabber <span class="ot">&lt;-</span> <span class="cf">function</span>(school_url) {</span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># We add a time sleep of 5 seconds to avoid</span></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>  <span class="co"># sending too many quick requests to the website</span></span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">Sys.sleep</span>(<span class="dv">5</span>)</span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a>  school_raw <span class="ot">&lt;-</span> <span class="fu">read_html</span>(school_url) <span class="sc">%&gt;%</span> <span class="fu">xml_child</span>()</span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a>  location_str <span class="ot">&lt;-</span></span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a>    school_raw <span class="sc">%&gt;%</span></span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">xml_find_all</span>(<span class="st">"//p[@class='d-flex align-items-baseline g-mt-5']//a"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">xml_attr</span>(<span class="at">attr =</span> <span class="st">"href"</span>)</span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-21"><a href="#cb19-21" aria-hidden="true" tabindex="-1"></a>  location <span class="ot">&lt;-</span></span>
<span id="cb19-22"><a href="#cb19-22" aria-hidden="true" tabindex="-1"></a>    location_str <span class="sc">%&gt;%</span></span>
<span id="cb19-23"><a href="#cb19-23" aria-hidden="true" tabindex="-1"></a>    <span class="fu">str_extract_all</span>(<span class="st">"=.+$"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb19-24"><a href="#cb19-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">str_replace_all</span>(<span class="st">"=|colegio</span><span class="sc">\\</span><span class="st">.longitud"</span>, <span class="st">""</span>) <span class="sc">%&gt;%</span></span>
<span id="cb19-25"><a href="#cb19-25" aria-hidden="true" tabindex="-1"></a>    <span class="fu">str_split</span>(<span class="st">"&amp;"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb19-26"><a href="#cb19-26" aria-hidden="true" tabindex="-1"></a>    .[[<span class="dv">1</span>]]</span>
<span id="cb19-27"><a href="#cb19-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-28"><a href="#cb19-28" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Turn into a data frame</span></span>
<span id="cb19-29"><a href="#cb19-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(</span>
<span id="cb19-30"><a href="#cb19-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">latitude =</span> location[<span class="dv">1</span>],</span>
<span id="cb19-31"><a href="#cb19-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">longitude =</span> location[<span class="dv">2</span>],</span>
<span id="cb19-32"><a href="#cb19-32" aria-hidden="true" tabindex="-1"></a>    <span class="at">stringsAsFactors =</span> <span class="cn">FALSE</span></span>
<span id="cb19-33"><a href="#cb19-33" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb19-34"><a href="#cb19-34" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb19-35"><a href="#cb19-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-36"><a href="#cb19-36" aria-hidden="true" tabindex="-1"></a><span class="fu">school_grabber</span>(school_url)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    latitude longitude
1 38.8274492 0.0221681</code></pre>
</div>
</div>
</section>
<section id="scaling-the-scraper-to-all-schools-2" class="level2">
<h2 class="anchored" data-anchor-id="scaling-the-scraper-to-all-schools-2">Scaling the scraper to all schools</h2>
<p>Works for a single school, let’s loop over all other schools:</p>
<div class="cell" data-layout-align="center" data-hash="case_study_spanish_schools_cache/html/unnamed-chunk-13_5acfbbe0e0ac4df8af175400283010f0">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>coordinates <span class="ot">&lt;-</span> <span class="fu">map_dfr</span>(school_links, school_grabber)</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>coordinates</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     latitude  longitude
1  42.7277870 -8.6567935
2  43.2443899 -8.8921645
3  38.9559234 -1.2255769
4  39.1865665 -1.6225903
5  40.3824530 -3.6410388
6  40.2292912 -3.1106322
7  40.4385997 -3.6970366
8  40.3351393 -3.5155669
9  40.5054637 -3.3738441
10 40.6382608 -3.4537107
11 40.3854323 -3.6639500
12 37.7648471 -1.5030467
13 38.8274492  0.0221681
14 40.9943370 -5.6224391
15 40.9943370 -5.6224391
16 40.5603732 -5.6703725
17 40.9943370 -5.6224391
18 40.9943370 -5.6224391
19 41.1359296  0.9901905
20 41.2615548  1.1670507
21 41.2285137  0.5461471
22 41.1458017  0.8199749
23 41.1834060  0.5680564
24 42.0781977  1.8203155
25 42.2524468  1.8621546
26 41.7376665  1.8383666
27 41.6234490  2.0013628</code></pre>
</div>
</div>
</section>
<section id="plotting-all-schools" class="level2">
<h2 class="anchored" data-anchor-id="plotting-all-schools">Plotting all schools</h2>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>coordinates <span class="ot">&lt;-</span> <span class="fu">mutate_all</span>(coordinates, as.numeric)</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>sp_sf <span class="ot">&lt;-</span></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ne_countries</span>(<span class="at">scale =</span> <span class="st">"large"</span>, <span class="at">country =</span> <span class="st">"Spain"</span>, <span class="at">returnclass =</span> <span class="st">"sf"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_transform</span>(<span class="at">crs =</span> <span class="dv">4326</span>)</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(sp_sf) <span class="sc">+</span></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>() <span class="sc">+</span></span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data =</span> coordinates, <span class="fu">aes</span>(<span class="at">x =</span> longitude, <span class="at">y =</span> latitude)) <span class="sc">+</span></span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_sf</span>(<span class="at">xlim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">20</span>, <span class="dv">10</span>), <span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">25</span>, <span class="dv">45</span>)) <span class="sc">+</span></span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">"Sample of schools in Spain"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="plotting-all-schools-1" class="level2">
<h2 class="anchored" data-anchor-id="plotting-all-schools-1">Plotting all schools</h2>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="case_study_spanish_schools_files/figure-html/unnamed-chunk-15-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="scraping-publicprivate-school" class="level2">
<h2 class="anchored" data-anchor-id="scraping-publicprivate-school">Scraping public/private school</h2>
<ul>
<li><p>Private/public school info can help understand inequality.</p></li>
<li><p>Mapping school location to average income at the neighborhood level</p></li>
<li><p>Correlating private/public school quotas with income can understand inequality patterns</p></li>
<li><p>Luckily, the website has the info for us</p></li>
</ul>
</section>
<section id="scraping-publicprivate-school-1" class="level2">
<h2 class="anchored" data-anchor-id="scraping-publicprivate-school-1">Scraping public/private school</h2>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/main_website_public_private-01.png" class="img-fluid figure-img"></p>
</figure>
</div>
<p><strong>“Centro Público” means Public School</strong></p>
</section>
<section id="scraping-publicprivate-school-2" class="level2">
<h2 class="anchored" data-anchor-id="scraping-publicprivate-school-2">Scraping public/private school</h2>
<p>Open up developer tools (<code>CTRL + SHIFT + c</code>) and hover over that info:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/tag_public_private.png" class="img-fluid figure-img"></p>
</figure>
</div>
</section>
<section id="scraping-publicprivate-school-3" class="level2">
<h2 class="anchored" data-anchor-id="scraping-publicprivate-school-3">Scraping public/private school</h2>
<p>Brainstorming scraping strategy:</p>
<ul>
<li><p>Info we want is within a <code>&lt;strong&gt;</code> tag</p></li>
<li><p><code>&lt;strong&gt;</code> is <strong>bold</strong> in HTML world</p></li>
<li><p>Too many matches if search for <code>&lt;strong&gt;</code></p></li>
<li><p>Find an ascendant with a unique attribute. For example: <code>&lt;div&gt;</code> tag with class <code>'col-6 g-brd-left g-brd-bottom g-theme-brd-gray-light-v3 g-px-15 g-py-25'</code></p></li>
</ul>
<p>Let’s try it.</p>
</section>
<section id="scraping-publicprivate-school-4" class="level2">
<h2 class="anchored" data-anchor-id="scraping-publicprivate-school-4">Scraping public/private school</h2>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>school_raw <span class="sc">%&gt;%</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xml_find_all</span>(<span class="st">"//div[@class='col-6 g-brd-left g-brd-bottom g-theme-brd-gray-light-v3 g-px-15 g-py-25']"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>{xml_nodeset (10)}
 [1] &lt;div class="col-6 g-brd-left g-brd-bottom g-theme-brd-gray-light-v3 g-px ...
 [2] &lt;div class="col-6 g-brd-left g-brd-bottom g-theme-brd-gray-light-v3 g-px ...
 [3] &lt;div class="col-6 g-brd-left g-brd-bottom g-theme-brd-gray-light-v3 g-px ...
 [4] &lt;div class="col-6 g-brd-left g-brd-bottom g-theme-brd-gray-light-v3 g-px ...
 [5] &lt;div class="col-6 g-brd-left g-brd-bottom g-theme-brd-gray-light-v3 g-px ...
 [6] &lt;div class="col-6 g-brd-left g-brd-bottom g-theme-brd-gray-light-v3 g-px ...
 [7] &lt;div class="col-6 g-brd-left g-brd-bottom g-theme-brd-gray-light-v3 g-px ...
 [8] &lt;div class="col-6 g-brd-left g-brd-bottom g-theme-brd-gray-light-v3 g-px ...
 [9] &lt;div class="col-6 g-brd-left g-brd-bottom g-theme-brd-gray-light-v3 g-px ...
[10] &lt;div class="col-6 g-brd-left g-brd-bottom g-theme-brd-gray-light-v3 g-px ...</code></pre>
</div>
</div>
<p>What? 10 matches? I was expecting one match..</p>
</section>
<section id="scraping-publicprivate-school-5" class="level2">
<h2 class="anchored" data-anchor-id="scraping-publicprivate-school-5">Scraping public/private school</h2>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/main_website_details_box.png" class="img-fluid figure-img"></p>
</figure>
</div>
</section>
<section id="scraping-publicprivate-school-6" class="level2">
<h2 class="anchored" data-anchor-id="scraping-publicprivate-school-6">Scraping public/private school</h2>
<p>One strategy is to extract content in all boxes and then extract the specific data we want:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>text_boxes <span class="ot">&lt;-</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>  school_raw <span class="sc">%&gt;%</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xml_find_all</span>(<span class="st">"//div[@class='col-6 g-brd-left g-brd-bottom g-theme-brd-gray-light-v3 g-px-15 g-py-25']//strong"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xml_text</span>()</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>text_boxes</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "616522706"                                                         
 [2] "966428835"                                                         
 [3] "03006839@edu.gva.es"                                               
 [4] "-"                                                                 
 [5] "966428836"                                                         
 [6] "3006839"                                                           
 [7] "Centro Público"                                                    
 [8] "Colegio de Educación Infantil y Primaria"                          
 [9] "GENERALITAT VALENCIANA"                                            
[10] "Vuelta al cole, inicio y fin de clases, vacaciones y días festivos"</code></pre>
</div>
</div>
</section>
<section id="scraping-publicprivate-school-7" class="level2">
<h2 class="anchored" data-anchor-id="scraping-publicprivate-school-7">Scraping public/private school</h2>
<ul>
<li><p>We don’t know if all schools will have exactly 10 boxes</p></li>
<li><p>Make it more precise with regex</p></li>
</ul>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>single_public_private <span class="ot">&lt;-</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>  text_boxes <span class="sc">%&gt;%</span></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">str_detect</span>(<span class="st">"Centro"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>  text_boxes[.]</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>single_public_private</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Centro Público"</code></pre>
</div>
</div>
</section>
<section id="scraping-publicprivate-school-8" class="level2">
<h2 class="anchored" data-anchor-id="scraping-publicprivate-school-8">Scraping public/private school</h2>
<p>Same strategy: apply it to one school and scale it to all others:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>grab_public_private_school <span class="ot">&lt;-</span> <span class="cf">function</span>(school_link) {</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">Sys.sleep</span>(<span class="dv">5</span>)</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>  school <span class="ot">&lt;-</span> <span class="fu">read_html</span>(school_link)</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>  text_boxes <span class="ot">&lt;-</span></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>    school <span class="sc">%&gt;%</span></span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">xml_find_all</span>(<span class="st">"//div[@class='col-6 g-brd-left g-brd-bottom g-theme-brd-gray-light-v3 g-px-15 g-py-25']//strong"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">xml_text</span>()</span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>  single_public_private <span class="ot">&lt;-</span></span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a>    text_boxes <span class="sc">%&gt;%</span></span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">str_detect</span>(<span class="st">"Centro"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a>    text_boxes[.]</span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-15"><a href="#cb30-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(</span>
<span id="cb30-16"><a href="#cb30-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">public_private =</span> single_public_private,</span>
<span id="cb30-17"><a href="#cb30-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">stringsAsFactors =</span> <span class="cn">FALSE</span></span>
<span id="cb30-18"><a href="#cb30-18" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb30-19"><a href="#cb30-19" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb30-20"><a href="#cb30-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-21"><a href="#cb30-21" aria-hidden="true" tabindex="-1"></a>public_private_schools <span class="ot">&lt;-</span> <span class="fu">map_dfr</span>(school_links, grab_public_private_school)</span>
<span id="cb30-22"><a href="#cb30-22" aria-hidden="true" tabindex="-1"></a>public_private_schools</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="scraping-publicprivate-school-9" class="level2">
<h2 class="anchored" data-anchor-id="scraping-publicprivate-school-9">Scraping public/private school</h2>
<div class="cell" data-layout-align="center" data-hash="case_study_spanish_schools_cache/html/unnamed-chunk-20_e16bb8ba08a4348fe8f6456c8e18ffa8">
<div class="cell-output cell-output-stdout">
<pre><code>   public_private
1  Centro Privado
2  Centro Público
3  Centro Público
4  Centro Público
5  Centro Privado
6  Centro Público
7  Centro Público
8  Centro Privado
9  Centro Público
10 Centro Público
11 Centro Público
12 Centro Público
13 Centro Público
14 Centro Público
15 Centro Público
16 Centro Público
17 Centro Público
18 Centro Privado
19 Centro Público
20 Centro Público
21 Centro Privado
22 Centro Público
23 Centro Privado
24 Centro Público
25 Centro Público
26 Centro Privado
27 Centro Público</code></pre>
</div>
</div>
</section>
<section id="scraping-publicprivate-school-10" class="level2">
<h2 class="anchored" data-anchor-id="scraping-publicprivate-school-10">Scraping public/private school</h2>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Let's translate the public/private names from Spanish to English</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>lookup <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Centro Público"</span> <span class="ot">=</span> <span class="st">"Public"</span>, <span class="st">"Centro Privado"</span> <span class="ot">=</span> <span class="st">"Private"</span>)</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>public_private_schools<span class="sc">$</span>public_private <span class="ot">&lt;-</span> lookup[public_private_schools<span class="sc">$</span>public_private]</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge it with the coordinates data</span></span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>all_schools <span class="ot">&lt;-</span> <span class="fu">cbind</span>(coordinates, public_private_schools)</span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot private/public by coordinates</span></span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(sp_sf) <span class="sc">+</span></span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>() <span class="sc">+</span></span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data =</span> all_schools, <span class="fu">aes</span>(<span class="at">x =</span> longitude, <span class="at">y =</span> latitude, <span class="at">color =</span> public_private)) <span class="sc">+</span></span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_sf</span>(<span class="at">xlim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">20</span>, <span class="dv">10</span>), <span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">25</span>, <span class="dv">45</span>)) <span class="sc">+</span></span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">"Sample of schools in Spain by private/public"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="scraping-publicprivate-school-11" class="level2">
<h2 class="anchored" data-anchor-id="scraping-publicprivate-school-11">Scraping public/private school</h2>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="case_study_spanish_schools_files/figure-html/unnamed-chunk-22-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="extracting-type-of-school" class="level2">
<h2 class="anchored" data-anchor-id="extracting-type-of-school">Extracting type of school</h2>
<p>One additional information that might also be useful to know is the type of each school: kindergarten, secondary school, primary school, etc. This information is just next to whether the school is private or public:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/main_website_type_school.png" class="img-fluid figure-img"></p>
</figure>
</div>
</section>
<section id="extracting-type-of-school-1" class="level2">
<h2 class="anchored" data-anchor-id="extracting-type-of-school-1">Extracting type of school</h2>
<p>Brain storm:</p>
<ul>
<li><p>This is the exact same code as before?</p></li>
<li><p>Can we recycle at least until extracting the <code>div</code> XPath?</p></li>
<li><p>Problem: we can’t know in advance the <em>type</em> of center so we can’t regex to detect it</p></li>
<li><p>Instead: detect <code>Tipo Centro</code>, genetic for “Type of center”</p></li>
</ul>
</section>
<section id="extracting-type-of-school-2" class="level2">
<h2 class="anchored" data-anchor-id="extracting-type-of-school-2">Extracting type of school</h2>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>text_boxes <span class="ot">&lt;-</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>  school_raw <span class="sc">%&gt;%</span></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xml_find_all</span>(<span class="st">"//div[@class='col-6 g-brd-left g-brd-bottom g-theme-brd-gray-light-v3 g-px-15 g-py-25']"</span>)</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>text_boxes</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>{xml_nodeset (10)}
 [1] &lt;div class="col-6 g-brd-left g-brd-bottom g-theme-brd-gray-light-v3 g-px ...
 [2] &lt;div class="col-6 g-brd-left g-brd-bottom g-theme-brd-gray-light-v3 g-px ...
 [3] &lt;div class="col-6 g-brd-left g-brd-bottom g-theme-brd-gray-light-v3 g-px ...
 [4] &lt;div class="col-6 g-brd-left g-brd-bottom g-theme-brd-gray-light-v3 g-px ...
 [5] &lt;div class="col-6 g-brd-left g-brd-bottom g-theme-brd-gray-light-v3 g-px ...
 [6] &lt;div class="col-6 g-brd-left g-brd-bottom g-theme-brd-gray-light-v3 g-px ...
 [7] &lt;div class="col-6 g-brd-left g-brd-bottom g-theme-brd-gray-light-v3 g-px ...
 [8] &lt;div class="col-6 g-brd-left g-brd-bottom g-theme-brd-gray-light-v3 g-px ...
 [9] &lt;div class="col-6 g-brd-left g-brd-bottom g-theme-brd-gray-light-v3 g-px ...
[10] &lt;div class="col-6 g-brd-left g-brd-bottom g-theme-brd-gray-light-v3 g-px ...</code></pre>
</div>
</div>
<p>10 boxes of the page</p>
</section>
<section id="extracting-type-of-school-3" class="level2">
<h2 class="anchored" data-anchor-id="extracting-type-of-school-3">Extracting type of school</h2>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>selected_node <span class="ot">&lt;-</span> text_boxes <span class="sc">%&gt;%</span> <span class="fu">xml_text</span>() <span class="sc">%&gt;%</span> <span class="fu">str_detect</span>(<span class="st">"Tipo Centro"</span>)</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>selected_node</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] FALSE FALSE FALSE FALSE FALSE FALSE  TRUE FALSE FALSE FALSE</code></pre>
</div>
</div>
<ul>
<li><p>Subset that node and from here on we can do as we did last time: extract the strong tag.</p></li>
<li><p>XPath <code>.//strong</code>. <code>.//strong</code> means to find all strong tags but the <code>.</code> means to search for all tags below the current selection.</p></li>
</ul>
</section>
<section id="extracting-type-of-school-4" class="level2">
<h2 class="anchored" data-anchor-id="extracting-type-of-school-4">Extracting type of school</h2>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>single_type_school <span class="ot">&lt;-</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>  text_boxes[selected_node] <span class="sc">%&gt;%</span></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xml_find_all</span>(<span class="st">".//strong"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xml_text</span>()</span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>single_type_school</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Colegio de Educación Infantil y Primaria"</code></pre>
</div>
</div>
</section>
<section id="extracting-type-of-school-5" class="level2">
<h2 class="anchored" data-anchor-id="extracting-type-of-school-5">Extracting type of school</h2>
<p>General strategy:</p>
<ol type="1">
<li>Recycle strategy of extracting all <code>div</code> tags</li>
<li>Can’t know in advance type of school. Search for generic wording in the box.</li>
<li>Extract the specific <code>div</code> node that matches the wording</li>
<li>Searching for the <code>strong</code> tag but <strong>only</strong> within that box with <code>.//strong</code>.</li>
</ol>
</section>
<section id="extracting-type-of-school-6" class="level2">
<h2 class="anchored" data-anchor-id="extracting-type-of-school-6">Extracting type of school</h2>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>grab_type_school <span class="ot">&lt;-</span> <span class="cf">function</span>(school_link) {</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">Sys.sleep</span>(<span class="dv">5</span>)</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>  school <span class="ot">&lt;-</span> <span class="fu">read_html</span>(school_link)</span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>  text_boxes <span class="ot">&lt;-</span></span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a>    school <span class="sc">%&gt;%</span></span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">xml_find_all</span>(<span class="st">"//div[@class='col-6 g-brd-left g-brd-bottom g-theme-brd-gray-light-v3 g-px-15 g-py-25']"</span>)</span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a>  selected_node <span class="ot">&lt;-</span></span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true" tabindex="-1"></a>    text_boxes <span class="sc">%&gt;%</span></span>
<span id="cb39-11"><a href="#cb39-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">xml_text</span>() <span class="sc">%&gt;%</span></span>
<span id="cb39-12"><a href="#cb39-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">str_detect</span>(<span class="st">"Tipo Centro"</span>)</span>
<span id="cb39-13"><a href="#cb39-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-14"><a href="#cb39-14" aria-hidden="true" tabindex="-1"></a>  single_type_school <span class="ot">&lt;-</span></span>
<span id="cb39-15"><a href="#cb39-15" aria-hidden="true" tabindex="-1"></a>    text_boxes[selected_node] <span class="sc">%&gt;%</span></span>
<span id="cb39-16"><a href="#cb39-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">xml_find_all</span>(<span class="st">".//strong"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb39-17"><a href="#cb39-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">xml_text</span>()</span>
<span id="cb39-18"><a href="#cb39-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-19"><a href="#cb39-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-20"><a href="#cb39-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(</span>
<span id="cb39-21"><a href="#cb39-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">type_school =</span> single_type_school,</span>
<span id="cb39-22"><a href="#cb39-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">stringsAsFactors =</span> <span class="cn">FALSE</span></span>
<span id="cb39-23"><a href="#cb39-23" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb39-24"><a href="#cb39-24" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb39-25"><a href="#cb39-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-26"><a href="#cb39-26" aria-hidden="true" tabindex="-1"></a>all_type_schools <span class="ot">&lt;-</span> <span class="fu">map_dfr</span>(school_links, grab_type_school)</span>
<span id="cb39-27"><a href="#cb39-27" aria-hidden="true" tabindex="-1"></a>all_type_schools</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="extracting-type-of-school-7" class="level2">
<h2 class="anchored" data-anchor-id="extracting-type-of-school-7">Extracting type of school</h2>
<div class="cell" data-layout-align="center" data-hash="case_study_spanish_schools_cache/html/unnamed-chunk-27_bf6d813c001cd5ba72e63c8b8507f552">
<div class="cell-output cell-output-stdout">
<pre><code>                                    type_school
1                              Escuela Infantil
2                              Escuela Infantil
3                              Escuela Infantil
4                              Escuela Infantil
5                              Escuela Infantil
6  Escuela de Educación Infantil, Casa de Niños
7                              Escuela Infantil
8                              Escuela Infantil
9                              Escuela Infantil
10 Escuela de Educación Infantil, Casa de Niños
11                             Escuela Infantil
12      Escuela Municipal de Educación Infantil
13     Colegio de Educación Infantil y Primaria
14                             Escuela Infantil
15                             Escuela Infantil
16                             Escuela Infantil
17                             Escuela Infantil
18                             Escuela Infantil
19                                       Escola
20                                       Escola
21                                       Escola
22                                       Escola
23                                       Escola
24                                       Escola
25                                       Escola
26                                       Escola
27                                       Escola</code></pre>
</div>
</div>
</section>
<section id="extracting-type-of-school-8" class="level2">
<h2 class="anchored" data-anchor-id="extracting-type-of-school-8">Extracting type of school</h2>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>all_schools <span class="ot">&lt;-</span> <span class="fu">cbind</span>(all_schools, all_type_schools)</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(sp_sf) <span class="sc">+</span></span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>() <span class="sc">+</span></span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data =</span> all_schools, <span class="fu">aes</span>(<span class="at">x =</span> longitude, <span class="at">y =</span> latitude, <span class="at">color =</span> public_private)) <span class="sc">+</span></span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_sf</span>(<span class="at">xlim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">20</span>, <span class="dv">10</span>), <span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">25</span>, <span class="dv">45</span>)) <span class="sc">+</span></span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> type_school) <span class="sc">+</span></span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">"Sample of schools in Spain"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="extracting-type-of-school-9" class="level2">
<h2 class="anchored" data-anchor-id="extracting-type-of-school-9">Extracting type of school</h2>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="case_study_spanish_schools_files/figure-html/unnamed-chunk-29-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="summary" class="level2">
<h2 class="anchored" data-anchor-id="summary">Summary</h2>
<ul>
<li><p>Web scraping is all about creativity</p></li>
<li><p>Knowing some XPath</p></li>
<li><p>Mastering some regex</p></li>
<li><p>Thinking outside the box</p></li>
</ul>
<p>🤯</p>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>
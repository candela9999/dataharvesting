<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.313">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Jorge Cimentada">

<title>Automating API programs</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="automating_apis_files/libs/clipboard/clipboard.min.js"></script>
<script src="automating_apis_files/libs/quarto-html/quarto.js"></script>
<script src="automating_apis_files/libs/quarto-html/popper.min.js"></script>
<script src="automating_apis_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="automating_apis_files/libs/quarto-html/anchor.min.js"></script>
<link href="automating_apis_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="automating_apis_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="automating_apis_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="automating_apis_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="automating_apis_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">


</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Automating API programs</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Jorge Cimentada </p>
          </div>
  </div>
    
  
    
  </div>
  

</header>

<div class="cell">

</div>
<section id="automating-apis" class="level2">
<h2 class="anchored" data-anchor-id="automating-apis">Automating APIs</h2>
<p>Ever wondered how you can grab real time data, <strong>on demand</strong>, without moving a finger?</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/scraping_gif.gif" class="img-fluid figure-img"></p>
</figure>
</div>
<p><strong>Welcome to the world of automation!</strong></p>
</section>
<section id="automating-apis-1" class="level2">
<h2 class="anchored" data-anchor-id="automating-apis-1">Automating APIs</h2>
<ul>
<li><p>Automating APIs is actually not that special</p></li>
<li><p>It is the same type of work for automating any script: web scraping, APIs, bots</p></li>
<li><p>Here we focus on a real example as a way to motivate automation</p></li>
<li><p>Grabbing real time data from a real-looking API</p></li>
</ul>
</section>
<section id="automating-apis-2" class="level2">
<h2 class="anchored" data-anchor-id="automating-apis-2">Automating APIs</h2>
<p>My story with bicycles:</p>
<p><img src="images/paste-4E2DD2D9.png" class="img-fluid"></p>
</section>
<section id="the-bicing-api" class="level2">
<h2 class="anchored" data-anchor-id="the-bicing-api">The Bicing API</h2>
<ul>
<li><code>scrapex</code> has a near-real copy of the Bicing API. Access it with:</li>
</ul>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(scrapex)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(httr2)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(readr)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>bicing <span class="ot">&lt;-</span> <span class="fu">api_bicing</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Visit your REST API at http://localhost:23892"
[1] "Documentation is at http://localhost:23892/__docs__/"</code></pre>
</div>
</div>
</section>
<section id="the-bicing-api-1" class="level2">
<h2 class="anchored" data-anchor-id="the-bicing-api-1">The Bicing API</h2>
<p>The first thing we want to check is the documentation:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/main_bicing_docs.png" class="img-fluid figure-img"></p>
</figure>
</div>
</section>
<section id="the-bicing-api-2" class="level2">
<h2 class="anchored" data-anchor-id="the-bicing-api-2">The Bicing API</h2>
<p>We want to check the single endpoint:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/endpoint_bicing.png" class="img-fluid figure-img"></p>
</figure>
</div>
</section>
<section id="the-bicing-api-3" class="level2">
<h2 class="anchored" data-anchor-id="the-bicing-api-3">The Bicing API</h2>
<ul>
<li><p>Access real time bicycle usage from a sample of 20 stations from Barcelona’s public bicycle system</p></li>
<li><p>No parameters needed</p></li>
<li><p>I’ve only included 20 stations from the original results</p></li>
<li><p>Data changes per request</p></li>
<li><p>If we want to understand bicycle patterns, we need to automate this process and we need to save this data somewhere.</p></li>
</ul>
</section>
<section id="talking-to-the-bicing-api" class="level2">
<h2 class="anchored" data-anchor-id="talking-to-the-bicing-api">Talking to the bicing API</h2>
<ul>
<li>Since no parameters are needed, we go make a request to the endpoint:</li>
</ul>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>rt_bicing <span class="ot">&lt;-</span> <span class="fu">paste0</span>(bicing<span class="sc">$</span>api_web, <span class="st">"/api/v1/real_time_bicycles"</span>)</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>resp_output <span class="ot">&lt;-</span> rt_bicing <span class="sc">%&gt;%</span> </span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">request</span>() <span class="sc">%&gt;%</span>  </span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">req_perform</span>()</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>resp_output</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>&lt;httr2_response&gt;</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>GET http://localhost:23892/api/v1/real_time_bicycles</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Status: 200 OK</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Content-Type: application/json</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Body: In memory (3312 bytes)</code></pre>
</div>
</div>
</section>
<section id="talking-to-the-bicing-api-1" class="level2">
<h2 class="anchored" data-anchor-id="talking-to-the-bicing-api-1">Talking to the Bicing API</h2>
<ul>
<li><p>Output is JSON</p></li>
<li><p>Status code is 200</p></li>
<li><p>Small data (1 byte = 0.000001 mb)</p></li>
</ul>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>sample_output <span class="ot">&lt;-</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>  resp_output <span class="sc">%&gt;%</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">resp_body_json</span>() <span class="sc">%&gt;%</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">head</span>(<span class="at">n =</span> <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="talking-to-the-bicing-api-2" class="level2">
<h2 class="anchored" data-anchor-id="talking-to-the-bicing-api-2">Talking to the Bicing API</h2>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>sample_output</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[[1]]
[[1]]$type
[1] "BIKE"

[[1]]$latitude
[1] 41.398

[[1]]$longitude
[1] 2.18

[[1]]$streetName
[1] "Gran Via Corts Catalanes"

[[1]]$streetNumber
[1] "760"

[[1]]$slots
[1] 29

[[1]]$current_time
[1] "2023-01-26 18:02:16"

[[1]]$in_use
[1] 6


[[2]]
[[2]]$type
[1] "BIKE"

[[2]]$latitude
[1] 41.3955

[[2]]$longitude
[1] 2.1771

[[2]]$streetName
[1] "Roger de Flor/ Gran Vía"

[[2]]$streetNumber
[1] "126"

[[2]]$slots
[1] 27

[[2]]$current_time
[1] "2023-01-26 18:02:16"

[[2]]$in_use
[1] 15</code></pre>
</div>
</div>
</section>
<section id="talking-to-the-bicing-api-3" class="level2">
<h2 class="anchored" data-anchor-id="talking-to-the-bicing-api-3">Talking to the Bicing API</h2>
<ul>
<li><p>Output looks like each slot is the row of a data frame where each contains a column, with names like <code>slots</code>, <code>in_use</code>, <code>latitude/longitude</code> and <code>streetName</code></p></li>
<li><p>Loop over each slot and simply try to convert it to a data frame</p></li>
<li><p>Each slot has a named list inside, <code>data.frame</code> can convert that directly to a data frame</p></li>
<li><p>Bind all those rows into a single data frame</p></li>
</ul>
</section>
<section id="talking-to-the-bicing-api-4" class="level2">
<h2 class="anchored" data-anchor-id="talking-to-the-bicing-api-4">Talking to the Bicing API</h2>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>sample_output <span class="sc">%&gt;%</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lapply</span>(data.frame) <span class="sc">%&gt;%</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  type latitude longitude               streetName streetNumber slots
1 BIKE  41.3980    2.1800 Gran Via Corts Catalanes          760    29
2 BIKE  41.3955    2.1771  Roger de Flor/ Gran Vía          126    27
         current_time in_use
1 2023-01-26 18:02:16      6
2 2023-01-26 18:02:16     15</code></pre>
</div>
</div>
<p><br></p>
<p>Works well 👏!</p>
</section>
<section id="talking-to-the-bicing-api-5" class="level2">
<h2 class="anchored" data-anchor-id="talking-to-the-bicing-api-5">Talking to the Bicing API</h2>
<p>Let’s scale it to entire response:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>all_stations <span class="ot">&lt;-</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>  resp_output <span class="sc">%&gt;%</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">resp_body_json</span>()</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>all_stations_df <span class="ot">&lt;-</span> </span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>  all_stations <span class="sc">%&gt;%</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lapply</span>(data.frame) <span class="sc">%&gt;%</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>()</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>all_stations_df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   type latitude longitude                     streetName streetNumber slots
1  BIKE  41.3980    2.1800       Gran Via Corts Catalanes          760    29
2  BIKE  41.3955    2.1771        Roger de Flor/ Gran Vía          126    27
3  BIKE  41.3941    2.1813                         Nàpols           82    27
4  BIKE  41.3935    2.1816                          Ribes           13    20
5  BIKE  41.3911    2.1802              Pg Lluís Companys           11    39
6  BIKE  41.3913    2.1806              Pg Lluís Companys           18    39
7  BIKE  41.3889    2.1833              Pg Lluís Companys            1    23
8  BIKE  41.3891    2.1836              Pg Lluís Companys            2    26
9  BIKE  41.3845    2.1849         Marquès de l'Argentera           13    26
10 BIKE  41.3817    2.1939                Passeig Marítim           19    21
11 BIKE  41.3845    2.1957         Pg Marítim Barceloneta           23    29
12 BIKE  41.3869    2.1958               Avinguda Litoral           16     3
13 BIKE  41.3847    2.1850 Avinguda del Marques Argentera           15    26
14 BIKE  41.3948    2.1712                         Girona           68    18
15 BIKE  41.3983    2.1867                  Av. Meridiana           47    21
16 BIKE  41.3982    2.1867                  Av. Meridiana           47    21
17 BIKE  41.4061    2.1742                       Rosselló          453    26
18 BIKE  41.4033    2.1707                       Rosselló          354    28
19 BIKE  41.4102    2.1758                      Cartagena          308    20
20 BIKE  41.4109    2.1740       Sant Antoni Maria Claret          214     2
          current_time in_use
1  2023-01-26 18:02:16      6
2  2023-01-26 18:02:16     15
3  2023-01-26 18:02:16      1
4  2023-01-26 18:02:16     19
5  2023-01-26 18:02:16     37
6  2023-01-26 18:02:16     25
7  2023-01-26 18:02:16      8
8  2023-01-26 18:02:16     16
9  2023-01-26 18:02:16     11
10 2023-01-26 18:02:16     12
11 2023-01-26 18:02:16     29
12 2023-01-26 18:02:16      2
13 2023-01-26 18:02:16     10
14 2023-01-26 18:02:16      2
15 2023-01-26 18:02:16      3
16 2023-01-26 18:02:16      0
17 2023-01-26 18:02:16     13
18 2023-01-26 18:02:16     20
19 2023-01-26 18:02:16      3
20 2023-01-26 18:02:16      2</code></pre>
</div>
</div>
</section>
<section id="talking-to-the-bicing-api-6" class="level2">
<h2 class="anchored" data-anchor-id="talking-to-the-bicing-api-6">Talking to the Bicing API</h2>
<p>Our strategy should also be to wrap everything in a function:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>real_time_bicing <span class="ot">&lt;-</span> <span class="cf">function</span>(bicing_api) {</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>  rt_bicing <span class="ot">&lt;-</span> <span class="fu">paste0</span>(bicing_api<span class="sc">$</span>api_web, <span class="st">"/api/v1/real_time_bicycles"</span>)</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>  resp_output <span class="ot">&lt;-</span> </span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>    rt_bicing <span class="sc">%&gt;%</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">request</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">req_perform</span>()</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>  all_stations <span class="ot">&lt;-</span></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>  resp_output <span class="sc">%&gt;%</span></span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">resp_body_json</span>()</span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>  all_stations_df <span class="ot">&lt;-</span> </span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>    all_stations <span class="sc">%&gt;%</span></span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">lapply</span>(data.frame) <span class="sc">%&gt;%</span></span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">bind_rows</span>()</span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a>  all_stations_df</span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="talking-to-the-bicing-api-7" class="level2">
<h2 class="anchored" data-anchor-id="talking-to-the-bicing-api-7">Talking to the Bicing API</h2>
<ul>
<li><p>Receives the bicing API object that has the API website</p></li>
<li><p>Makes a request to the API</p></li>
<li><p>Combines all results into a data frame and returns the data frame.</p></li>
<li><p>Using this example function we can confirm that making two requests will return different data in terms of bicycle usage.</p></li>
</ul>
</section>
<section id="talking-to-the-bicing-api-8" class="level2">
<h2 class="anchored" data-anchor-id="talking-to-the-bicing-api-8">Talking to the Bicing API</h2>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>first <span class="ot">&lt;-</span> <span class="fu">real_time_bicing</span>(bicing) <span class="sc">%&gt;%</span> <span class="fu">select</span>(in_use) <span class="sc">%&gt;%</span> <span class="fu">rename</span>(<span class="at">first_in_use =</span> in_use)</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>second <span class="ot">&lt;-</span> <span class="fu">real_time_bicing</span>(bicing) <span class="sc">%&gt;%</span> <span class="fu">select</span>(in_use) <span class="sc">%&gt;%</span> <span class="fu">rename</span>(<span class="at">second_in_use =</span> in_use)</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="fu">bind_cols</span>(first, second)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   first_in_use second_in_use
1             3            18
2            17            21
3            21             3
4            14             6
5            31            33
6            20            34
7            14            10
8            20             0
9            23             5
10           15            15
11            6             2
12            1             2
13           24            20
14           12             3
15           16             8
16            7            10
17            3            26
18            8            17
19           17            19
20            2             1</code></pre>
</div>
</div>
</section>
<section id="saving-data-in-api-programs" class="level2">
<h2 class="anchored" data-anchor-id="saving-data-in-api-programs">Saving data in API programs</h2>
<p>For saving data we need to focus on several things:</p>
<ul>
<li><p>We must perform the request to the bicing API</p></li>
<li><p>We must specify a local path where the CSV file will be saved. If the directory of the CSV file has not been created, we should create it.</p></li>
<li><p>If the CSV file does not exist, then we should create it from scratch</p></li>
<li><p>If the CSV file <em>exists</em>, then we want to append the result</p></li>
</ul>
</section>
<section id="saving-data-in-api-programs-1" class="level2">
<h2 class="anchored" data-anchor-id="saving-data-in-api-programs-1">Saving data in API programs</h2>
<p><br></p>
<p><br></p>
<p><strong>You’ll see that in the remaining part of this chapter I’ll use my local path to save the CSV file. This is in the variable <code>local_csv</code>. You should replace this with your local path before running any of the R code below</strong>.</p>
</section>
<section id="saving-data-in-api-programs-2" class="level2">
<h2 class="anchored" data-anchor-id="saving-data-in-api-programs-2">Saving data in API programs</h2>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>save_bicing_data <span class="ot">&lt;-</span> <span class="cf">function</span>(bicing_api) {</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Perform a request to the bicing API and get the data frame back</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>  bicing_results <span class="ot">&lt;-</span> <span class="fu">real_time_bicing</span>(bicing_api)</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Specify the local path where the file will be saved</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>  local_csv <span class="ot">&lt;-</span> <span class="st">"/home/jorge.cimentada/bicing/bicing_history.csv"</span></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Extract the directory where the local file is saved</span></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>  main_dir <span class="ot">&lt;-</span> <span class="fu">dirname</span>(local_csv)</span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>  <span class="co"># If the directory does *not* exist, create it, recursively creating each folder  </span></span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">dir.exists</span>(main_dir)) {</span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">dir.create</span>(main_dir, <span class="at">recursive =</span> <span class="cn">TRUE</span>)</span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a>  <span class="co"># If the file does not exist, save the current bicing response  </span></span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">file.exists</span>(local_csv)) {</span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">write_csv</span>(bicing_results, local_csv)</span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># If the file does exist, the *append* the result to the already existing CSV file</span></span>
<span id="cb19-21"><a href="#cb19-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">write_csv</span>(bicing_results, local_csv, <span class="at">append =</span> <span class="cn">TRUE</span>)</span>
<span id="cb19-22"><a href="#cb19-22" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb19-23"><a href="#cb19-23" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="saving-data-in-api-programs-3" class="level2">
<h2 class="anchored" data-anchor-id="saving-data-in-api-programs-3">Saving data in API programs</h2>
<p>One way to test whether this works is to run this twice and read the results back to a data frame to check that the data frame is correctly structured:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="fu">save_bicing_data</span>(bicing)</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="fu">Sys.sleep</span>(<span class="dv">5</span>)</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a><span class="fu">save_bicing_data</span>(bicing)</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>bicing_history <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"/home/jorge.cimentada/bicing/bicing_history.csv"</span>)</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>bicing_history <span class="sc">%&gt;%</span></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>(current_time)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<pre><code>## # A tibble: 2 × 1
##   current_time       
##   &lt;dttm&gt;             
## 1 2022-12-20 23:51:56
## 2 2022-12-20 23:52:04</code></pre>
</section>
<section id="saving-data-in-api-programs-4" class="level2">
<h2 class="anchored" data-anchor-id="saving-data-in-api-programs-4">Saving data in API programs</h2>
<p>In addition, we should also have two different numbers in the column <code>in_use</code> for the number of bicycles under usage. Let’s pick one station to check that it works:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>bicing_history <span class="sc">%&gt;%</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(streetName <span class="sc">==</span> <span class="st">"Ribes"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(current_time, streetName, in_use)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<pre><code>## # A tibble: 2 × 3
##   current_time        streetName in_use
##   &lt;dttm&gt;              &lt;chr&gt;       &lt;dbl&gt;
## 1 2022-12-20 23:51:56 Ribes          13
## 2 2022-12-20 23:52:04 Ribes          19</code></pre>
</section>
<section id="automating-the-program" class="level2">
<h2 class="anchored" data-anchor-id="automating-the-program">Automating the program</h2>
<p>Here’s when the fun part begins.</p>
<ol type="1">
<li>We create a script that defines the functions we’ll use for the program.</li>
<li>Run the functions at the end of that script.</li>
<li>Automate the process using <code>cron</code> by running the script in a schedule.</li>
</ol>
</section>
<section id="automating-the-program-1" class="level2">
<h2 class="anchored" data-anchor-id="automating-the-program-1">Automating the program</h2>
<p>Here’s what we have:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(scrapex)</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(httr2)</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(readr)</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>bicing <span class="ot">&lt;-</span> <span class="fu">api_bicing</span>()</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>real_time_bicing <span class="ot">&lt;-</span> <span class="cf">function</span>(bicing_api) {</span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>  rt_bicing <span class="ot">&lt;-</span> <span class="fu">paste0</span>(bicing_api<span class="sc">$</span>api_web, <span class="st">"/api/v1/real_time_bicycles"</span>)</span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a>  resp_output <span class="ot">&lt;-</span> </span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a>    rt_bicing <span class="sc">%&gt;%</span></span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">request</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">req_perform</span>()</span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a>  all_stations <span class="ot">&lt;-</span></span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true" tabindex="-1"></a>  resp_output <span class="sc">%&gt;%</span></span>
<span id="cb24-18"><a href="#cb24-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">resp_body_json</span>()</span>
<span id="cb24-19"><a href="#cb24-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-20"><a href="#cb24-20" aria-hidden="true" tabindex="-1"></a>  all_stations_df <span class="ot">&lt;-</span> </span>
<span id="cb24-21"><a href="#cb24-21" aria-hidden="true" tabindex="-1"></a>    all_stations <span class="sc">%&gt;%</span></span>
<span id="cb24-22"><a href="#cb24-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">lapply</span>(data.frame) <span class="sc">%&gt;%</span></span>
<span id="cb24-23"><a href="#cb24-23" aria-hidden="true" tabindex="-1"></a>    <span class="fu">bind_rows</span>()</span>
<span id="cb24-24"><a href="#cb24-24" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb24-25"><a href="#cb24-25" aria-hidden="true" tabindex="-1"></a>  all_stations_df</span>
<span id="cb24-26"><a href="#cb24-26" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb24-27"><a href="#cb24-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-28"><a href="#cb24-28" aria-hidden="true" tabindex="-1"></a>save_bicing_data <span class="ot">&lt;-</span> <span class="cf">function</span>(bicing_api) {</span>
<span id="cb24-29"><a href="#cb24-29" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Perform a request to the bicing API and get the data frame back</span></span>
<span id="cb24-30"><a href="#cb24-30" aria-hidden="true" tabindex="-1"></a>  bicing_results <span class="ot">&lt;-</span> <span class="fu">real_time_bicing</span>(bicing_api)</span>
<span id="cb24-31"><a href="#cb24-31" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb24-32"><a href="#cb24-32" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Specify the local path where the file will be saved</span></span>
<span id="cb24-33"><a href="#cb24-33" aria-hidden="true" tabindex="-1"></a>  local_csv <span class="ot">&lt;-</span> <span class="st">"/home/jorge.cimentada/bicing/bicing_history.csv"</span></span>
<span id="cb24-34"><a href="#cb24-34" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb24-35"><a href="#cb24-35" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Extract the directory where the local file is saved</span></span>
<span id="cb24-36"><a href="#cb24-36" aria-hidden="true" tabindex="-1"></a>  main_dir <span class="ot">&lt;-</span> <span class="fu">dirname</span>(local_csv)</span>
<span id="cb24-37"><a href="#cb24-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-38"><a href="#cb24-38" aria-hidden="true" tabindex="-1"></a>  <span class="co"># If the directory does *not* exist, create it, recursively creating each folder  </span></span>
<span id="cb24-39"><a href="#cb24-39" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">dir.exists</span>(main_dir)) {</span>
<span id="cb24-40"><a href="#cb24-40" aria-hidden="true" tabindex="-1"></a>    <span class="fu">dir.create</span>(main_dir, <span class="at">recursive =</span> <span class="cn">TRUE</span>)</span>
<span id="cb24-41"><a href="#cb24-41" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb24-42"><a href="#cb24-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-43"><a href="#cb24-43" aria-hidden="true" tabindex="-1"></a>  <span class="co"># If the file does not exist, save the current bicing response  </span></span>
<span id="cb24-44"><a href="#cb24-44" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">file.exists</span>(local_csv)) {</span>
<span id="cb24-45"><a href="#cb24-45" aria-hidden="true" tabindex="-1"></a>    <span class="fu">write_csv</span>(bicing_results, local_csv)</span>
<span id="cb24-46"><a href="#cb24-46" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb24-47"><a href="#cb24-47" aria-hidden="true" tabindex="-1"></a>    <span class="co"># If the file does exist, the *append* the result to the already existing CSV file</span></span>
<span id="cb24-48"><a href="#cb24-48" aria-hidden="true" tabindex="-1"></a>    <span class="fu">write_csv</span>(bicing_results, local_csv, <span class="at">append =</span> <span class="cn">TRUE</span>)</span>
<span id="cb24-49"><a href="#cb24-49" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb24-50"><a href="#cb24-50" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb24-51"><a href="#cb24-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-52"><a href="#cb24-52" aria-hidden="true" tabindex="-1"></a><span class="fu">save_bicing_data</span>(bicing)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="automating-the-program-2" class="level2">
<h2 class="anchored" data-anchor-id="automating-the-program-2">Automating the program</h2>
<ul>
<li>Save that script in a newly create folder. I did that in <code>~/bicing/</code></li>
</ul>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/console_ls_bicing.png" class="img-fluid figure-img"></p>
</figure>
</div>
</section>
<section id="automating-the-program-3" class="level2">
<h2 class="anchored" data-anchor-id="automating-the-program-3">Automating the program</h2>
<ul>
<li>Test it first:</li>
</ul>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/results_api_bicing_console.png" class="img-fluid figure-img"></p>
</figure>
</div>
</section>
<section id="automating-the-program-4" class="level2">
<h2 class="anchored" data-anchor-id="automating-the-program-4">Automating the program</h2>
<p>If it works:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/ls_bicing_history.png" class="img-fluid figure-img"></p>
</figure>
</div>
</section>
<section id="automating-the-program-5" class="level2">
<h2 class="anchored" data-anchor-id="automating-the-program-5">Automating the program</h2>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/bicing_history_csv.png" class="img-fluid figure-img"></p>
</figure>
</div>
</section>
<section id="automating-the-program-6" class="level2">
<h2 class="anchored" data-anchor-id="automating-the-program-6">Automating the program</h2>
<p>Let’s set the schedule:</p>
<ol type="1">
<li>Open cron with <code>crontab -e</code></li>
<li>Define command to run: <code>* * * * * Rscript /home/jorge.cimentada/bicing/api_bicing.R</code></li>
<li>Paste it into the <code>cron</code> tab</li>
<li>Exit <code>cron</code>
<ol type="1">
<li><p>Hit CTRL and X (this is for exiting the cron interface)</p></li>
<li><p>It will prompt you to save the file. Press Y to save it.</p></li>
<li><p>Press enter to save the cron schedule file with the same name it has.</p></li>
</ol></li>
</ol>
</section>
<section id="automating-the-program-7" class="level2">
<h2 class="anchored" data-anchor-id="automating-the-program-7">Automating the program</h2>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/main_menu_crontab.png" class="img-fluid figure-img"></p>
</figure>
</div>
</section>
<section id="automating-the-program-8" class="level2">
<h2 class="anchored" data-anchor-id="automating-the-program-8">Automating the program</h2>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/rscript_cron.png" class="img-fluid figure-img"></p>
</figure>
</div>
</section>
<section id="automating-the-program-9" class="level2">
<h2 class="anchored" data-anchor-id="automating-the-program-9">Automating the program</h2>
<p>Exit cron and wait a few minutes…⏲️</p>
</section>
<section id="automating-the-program-10" class="level2">
<h2 class="anchored" data-anchor-id="automating-the-program-10">Automating the program</h2>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/bicing_history_cron.png" class="img-fluid figure-img"></p>
</figure>
</div>
</section>
<section id="summary" class="level2">
<h2 class="anchored" data-anchor-id="summary">Summary</h2>
<ul>
<li><p>Real time data often needs frequent requests</p></li>
<li><p><code>cron</code> is your friend for that</p></li>
<li><p>Saving data on each request is paramount (could by database or locally)</p></li>
<li><p>Automation can take you a long way!</p></li>
</ul>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>
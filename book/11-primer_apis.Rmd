```{r primer-api, echo = FALSE, eval = TRUE}
main_dir_api <- "./images/intro_api"

knitr::opts_chunk$set(
  echo = TRUE,
  eval = TRUE,
  message = FALSE,
  warning = FALSE,
  fig.align = "center",
  fig.path = paste0(main_dir_api, "/automatic_rmarkdown/"),
  fig.asp = 0.618
)

```


# A primer on APIs

When you make requests to an API, most probably you want to do them programmatically. By programmatically I mean to request data using a programming language. In this book we'll do it with Rbut you can do this with most programming languages.

Why do you want to do this programmatically when you can just use the documentation page to make sample requests? For several reasons. First, you can create a scheduled programme to download data on specific intervals of time. Doing that in a web browser would be tedious. Second, APIs are built to make thousands of requests per second/minutes. You might want to make 5 requests every minute. That sounds like a handful for a human clicking in a browser through out the day, right? Third and finally, because you can do much more within a programming language. For example, you might want to request some data from an endpoint that is then passed as input into another endpoint, which has a fallback value in case the request doesn't not return any data.

APIs are just a way to gather data. Using a programming language allows you to automate the gathering of data and add value in the data gathering process. In this chapter we'll give a primer on how to request data from an API in R.

As we did in # TODO primer webscraping, throughout this chapter I'll give you a one-to-one tour on what to expect when requesting data from an API in the wild. We'll skip the usual 'start from the basics' sections to directly request data from an API and see results from your efforts right away. Before we begin, let's load the packages we'll use in this chapter:

```{r}
library(scrapex)
library(httr2)
library(purrr)
library(tidyr)
```

As usual, we'll be using the `scrapex` package. This package contains an internal API that wraps the ![COVerAGE-DB](https://www.coverage-db.org/) database. COVerAGE-DB is an open-access database including cumulative counts of confirmed COVID-19 cases, deaths, tests, and vaccines by age and sex. For more information, visit their website at ![https://www.coverage-db.org/](https://www.coverage-db.org/).

```{r}
api_covid <- api_coveragedb(port = 35907)
api_covid
```

```{r}
api_web <- paste0(api_covid$api_web, "/api/v1/covid_cases")
req <- request(api_web)

req <-
  req %>%
  req_url_query(region = "New York State", sex = "m")

req
```

```{r}
print(req)

res_req <-
  req %>%
  req_perform()

cali_data <-
  res_req %>%
  resp_body_json() %>%
  transpose() %>%
  as_tibble() %>%
  unnest()

cali_data
```

```{r}
api_covid$process$kill()
```
